version: '3.8'
services:
  # Override thunderline service for devcontainer development
  thunderline:
    volumes:
      # Mount project root to /app for development
      - ..:/app:cached
      # Persist mix dependencies across rebuilds
      - thunderline_mix:/app/deps
      - thunderline_build:/app/_build

    # Enable debugging capabilities
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined

    # Set working directory
    working_dir: /app

    # Overrides default command so things don't shut down after the process ends.
    # Keeps container alive for VS Code to attach
    command: sleep infinity

    # Additional environment variables for dev container
    environment:
      DATABASE_URL: ecto://postgres:postgres@postgres:5432/thunderline
      SECRET_KEY_BASE: dev_dev_dev_dev_dev_dev_dev_dev_dev_dev_dev_dev_dev_dev
      TOKEN_SIGNING_SECRET: dev_token_signing_secret
      MIX_ENV: dev
      # Dev observability and gating toggles
      OTEL_DISABLED: "1"
      GATE_SELFTEST_DISABLED: "1"
      # MLflow tracking
      MLFLOW_TRACKING_URI: http://mlflow:5000

volumes:
  thunderline_mix:
  thunderline_build:
 

---
config:
  layout: dagre
  theme: neo-dark
---
flowchart LR
    BLOCK["ThunderBlock\n(Persistence)"] -- event/state --> FLOW["ThunderFlow\n(Event/Telemetry)"]
    GATE["ThunderGate\n(Security)"] -- authN/Z/events --> FLOW
    LINK["ThunderLink\n(Comms + Voice)"] -- voice+msg events --> FLOW
    GRID["ThunderGrid\n(Spatial)"] -- zone events --> FLOW
    BOLT["ThunderBolt\n(Orchestration)"] -- orchestration events --> FLOW
    CROWN["ThunderCrown\n(Governance/AI)"] -- ai/intent events --> FLOW
    FLOW -- feedback --> BLOCK
    FLOW -- signals --> GATE
    FLOW -- updates --> LINK
    FLOW -- placement --> GRID
    FLOW -- tasks/compute --> BOLT
    FLOW -- ai/context --> CROWN
    BLOCK -- infra config --- GATE
    GATE -- federate & auth --- LINK
    LINK -- placement --- GRID
    GRID -- jobs/ops --- BOLT
    BOLT -- intent + plans --- CROWN
    CROWN -- policy --- BLOCK

    %% Block domain resources
    BLOCK --> blkVault["Postgres / Mnesia (Thundervault)"]
    BLOCK --> vine["Thundervine (DAG Orchestrator)"]

    %% Gate domain
    GATE --> gatePolicy["Policy / Rate Limiter"]
    gatePolicy --> gateBridge["ThunderBridge (Ingest / Egress)"] & gateBridge

    %% Link domain
    LINK --> lnkChan["Communities / Channels"] & voiceChan["VoiceChannel (signaling)"]
    voiceChan --> voiceSup["VoiceSupervisor / DynamicRoom"]
    voiceSup --> voiceRoomRes["VoiceRoom"]
    voiceRoomRes --> voicePartRes["VoiceParticipant"] & voiceDevRes["VoiceDevice"]

    %% Flow domain
    FLOW --> flowBus["EventBus / Thunderline.Event (logical)"]

    %% Bolt domain
    BOLT --> boltPlan["Plan / DAG Orchestrator"]
    boltPlan --> boltLane["Lane Engine (modern)"]
    boltLane --> boltCell["ThunderCell (CA / compute kernels)"] & boltJobs["Workers / Jobs"]
    boltCell -- snapshots --> blkVault

    %% Crown domain
    CROWN --> crnMCP["Hermes MCP Bus"]
    crnMCP --> crnAI["AI Orchestration / Tool Select"]
    crnAI -- request model/tool --> gatePolicy
    gateBridge -- egress --> extAPI["External APIs / LLMs"]

    %% Grid domain
    GRID --> grZones["Zones / ECS Runtime"]

    %% Voice â†’ Flow events
    voiceChan -- "voice.signal.*" --> flowBus
    voiceSup -- "voice.room.*" --> flowBus
    flowBus -- telemetry --> blkVault

    %% TURN/STUN
    gateBridge --> turn["TURN/STUN (future)"]

    %% Thundervine connections
    flowBus -->|"cmd.workflow.plan / execute"| vine
    boltPlan -->|"consume workflow DAG"| vine
    vine -->|"persist DAG nodes/edges"| blkVault
    vine -->|"dag.commit"| FLOW
    vine -->|"lineage for agents"| CROWN

    %% Classes
    BLOCK:::domain
    FLOW:::central
    GATE:::domain
    LINK:::domain
    GRID:::domain
    BOLT:::domain
    CROWN:::domain
    blkVault:::store
    gatePolicy:::bridge
    gateBridge:::bridge
    lnkChan:::res
    voiceChan:::res
    voiceSup:::res
    voiceRoomRes:::res
    voicePartRes:::res
    voiceDevRes:::res
    flowBus:::pipe
    boltPlan:::res
    boltLane:::res
    boltCell:::res
    boltJobs:::res
    crnMCP:::res
    crnAI:::res
    extAPI:::ext
    grZones:::res
    turn:::ext
    vine:::res

    classDef domain fill:#204059,stroke:#77b8e0,stroke-width:2px,color:#e7faff,rx:14,ry:14
    classDef central fill:#282940,stroke:#dde0ff,stroke-width:3px,color:#fff
    classDef res fill:#233,stroke:#7df,color:#e3faff,rx:6,ry:6
    classDef store fill:#0f1f1f,stroke:#4fd,color:#d9ffff,rx:6,ry:6
    classDef bridge fill:#20201f,stroke:#d4b14a,color:#fff7d5,rx:6,ry:6,stroke-dasharray:3 2
    classDef pipe fill:#0e1633,stroke:#6aa0ff,color:#ebf3ff,rx:6,ry:6
    classDef ext fill:#2b150e,stroke:#ffb28a,color:#fff7f2,rx:6,ry:6
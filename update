Scanning whatâ€™s already built so we can anchor the Thunderblock Server (Discordâ€‘style) MVP on solid ground.

## âœ… Checklist of Your Ask
- Inventory current capabilities relevant to a Discordâ€‘style comms server
- Map them to MVP goals (comms, channels, presence, messaging, file system, CLI)
- Surface gaps, stubs, naming mismatches, risks
- Call out reuse opportunities vs things to cut or harden
- Confirm alignment (â€œwith youâ€) and propose next concrete moves

## ğŸ§¬ Current Core Assets (What You Already Have)

### 1. Domains & Architecture
- Thunderlink Domain: Explicitly positioned for â€œCommunication & Networkingâ€ with resources: Channel, Message, Community, Role, Ticket, FederationSocket, PACHome.
- Thunderblock Domain: Infrastructure + persistence + memory + orchestration resources (ExecutionContainer, TaskOrchestrator, Vault* resources, SystemEvent, etc.).
- Application Supervision: PubSub, Repo, Oban (AshOban integrated with fallback), event pipelines, circuit breaker, websocket client, metrics, bridges, LiveView dashboard.

### 2. Messaging & Channels
- `Thunderline.Thunderlink.Resources.Channel`: Rich schema (metrics, config, status, visibility, moderation, pinned messages, tags).
  - Has JSON:API routes scaffolded.
  - Action surface includes send_message, join/leave, pin/archive/lock/unlock, update_metrics.
  - Many internal functions stubbed: create_channel_message/2, initialize_* functions, participation tracking.
  - Broadcast topics use prefix `"thunderblock:..."` not `"thunderlink:..."` â†’ naming inconsistency / cognitive friction.
- `Thunderline.Thunderlink.Resources.Message`: Very feature-dense model (threads, reactions, moderation, AI/PAC metadata, ephemeral messages, search, flags, attachments).
  - After-action hooks broadcast to PubSub topics (also with thunderblock-prefixed naming misaligned with domain).
  - Search, thread stats, moderation, and channel stats updates are placeholders (no real implementations).
  - Oban triggers commented out (cleanup/moderation loops not active).
  - Validation and fragment-based filters for recent/search commented out (Ash 3.x expression migration incomplete).
  - Reaction + edit logic implemented locally; no cross-resource relationship enforcement for thread roots yet.

### 3. Community / Multi-Tenancy Layer
- Channel belongs to a Community (Thunderlink side).
- Separate â€œCommunityâ€ also exists under Thunderblock (`Thunderblock.Resources.Community`) provisioning execution zones; potential name collision / conceptual overlap with Thunderlink community (you have two â€œCommunityâ€ concepts?).
  - Thunderlink Community resource not yet inspected here, but duplication risk likely (need a single authoritative â€œrealm/communityâ€ model).

### 4. Event System
- `SystemEvent` resource (Thunderblock) with status lifecycle + correlation_id identity.
- Pipelines & Observability processes exist (Thunderflow land).
- No explicit consumer wiring translating SystemEvent â†’ Channel/Message actions yet.

### 5. PubSub / Real-Time
- PubSub running and in use for broadcasts.
- LiveView dashboards (metrics, automata) already functioning.
- No chat LiveView or Phoenix Channel (transport) layer specialized for messaging yet.
- Presence layer not implemented (no `ThunderlineWeb.Presence` module).

### 6. Authentication / Users
- `VaultUser` resource (email, password hash, roles, timestamps).
- Policies commented out pending AshAuthentication alignment.
- No direct linkage between `VaultUser` and Thunderlink messages beyond raw `sender_id` (no relationship defined in Message to user; only a raw UUID).
- User tokens resource present (not reviewed here but implied).

### 7. Storage / Files / Attachments
- Message has `attachments :: [%{...}]` but:
  - No file resource
  - No upload workflow
  - No blob persistence layer
  - No content-type/security validation
- Vault resources deal with â€œknowledge/memoryâ€ but not a file / asset store.

### 8. CLI / Terminal Interface
- Nothing yet resembling a LiveView terminal or streaming command execution.
- CircuitBreaker, Backoff, etc. exist (support utilities you can leverage for resilient CLI commands / remote exec later).

### 9. Governance / Moderation
- Message has moderation stubs (toxicity/spam metadata).
- Channel has moderation_config.
- No enforcement logic hooks (e.g., rejecting content on create) or quarantine path.
- No rate limiter enforcement despite RateLimitPolicy resource existing on infrastructure side.

### 10. Observability & Metrics
- Channel + Message schemas have metrics fields but update functions are placeholders.
- Fanout / queue depth collectors exist (Thunderflow) â€“ can be repurposed to feed per-channel throughput metrics if we publish instrumentation events.

### 11. Jobs / Scheduling
- Oban configured; message/channel scheduled jobs commented out.
- Can re-enable after AshOban expression upgrades (migrate commented fragment usages to Ash 3.x idioms).

### 12. Naming / Cohesion Issues
- PubSub topics use `thunderblock:` prefix for Thunderlink resources â†’ leak of historical consolidation step.
- â€œCommunityâ€ appears both as an execution-zone concept (Thunderblock) and a social grouping (Thunderlink).
- Mixed prefixes will confuse client implementers and domain authors.

## ğŸ§© MVP Capability Matrix

| MVP Capability | Current State | Gaps / Risks | Effort Tier |
| -------------- | ------------- | ------------ | ----------- |
| Real-time text channels | Data models & PubSub broadcasts exist | No LiveView/Channel UI, no presence, creation logic stubbed | Medium |
| Threading & replies | Schema & fields present | Thread root resolution stubbed; no UI/query surfaces | Medium |
| Reactions | Add/remove implemented | No dedupe constraints, no UI or event normalization | Low |
| Presence (online, typing) | None | Need Phoenix.Presence module + track hooks | Low |
| Message search | Fields + index hints | Actual tsvector generation + query disabled | High (needs migrations & db functions) |
| Moderation | Metadata placeholders | No enforcement pipeline or auto-moderation jobs | Medium |
| Ephemeral messages | Field + cleanup action | Trigger disabled; scheduling commented out | Low |
| Pinned messages | Channel has pinned list; message pin action | Cross-resource sync uses Channel.pin_message (not implemented hereâ€” referenced wrong module: Thunderblock.Resources.Channel) | Low-Medium (fix namespace & implement) |
| Communities / guild abstraction | Two competing community concepts | Need unification or clear rename (e.g. ExecutionRealm vs SocialCommunity) | High (conceptual) |
| File attachments | Placeholder array | Need storage (e.g. Arc/Waffle or custom S3 + presigned), validation, secure serve | High |
| CLI (terminal) | None | Implement LiveView session + command runner (Task / Port) | Medium |
| AuthZ | Policies disabled | Re-enable + role mapping + per-channel visibility gates | Medium |
| Federation | Metadata fields | No federation bus or signature verification | High (out of MVP unless mandated) |
| Performance metrics | Fields | No instrumentation feeding them | Low |
| Rate limiting | RateLimitPolicy resource exists | Not applied in channel/message create actions | Medium |
| Event-driven integration | SystemEvent exists | No workflow consuming system events into channels (e.g. system messages) | Medium |
| AI / PAC messaging | Metadata & message types | No processing/backends invoked | Defer (beyond baseline) |

## ğŸ›‘ Key Gaps to Close First (Critical Path)

1. Remove namespace confusion (topics + community duality)
2. Implement actual message creation pathway (Channel.send_message should persist via Message resource rather than stub)
3. Add Presence module & integrate into LiveView Chat UI
4. Build Chat LiveView:
   - Stream messages (LiveView streams)
   - Listen on PubSub topics per channel
   - Typing indicators + presence
5. Persist & display new messages (Ash create + broadcast)
6. Basic channel list & switcher with categories
7. Minimal auth (anonymous guest + registered user) + secure assign of user id
8. Pin/favorite, edit, delete (the ones already modeled)
9. Re-enable moderation + ephemeral cleanup as cron later (post-baseline)
10. CLI LiveView shell (foundation for admin control / system introspection)

## ğŸ¯ Proposed Execution Phases (Concrete)

### Phase A: Stabilize Data + Naming
- Rename PubSub topics from `"thunderblock:channels:*"` â†’ `"thunderlink:channels:*"` (or `"thunder:chan:*"` for brevity)
- Clarify â€œCommunityâ€ duplication:
  - Option 1: Rename Thunderblock execution notion to `ExecutionZone`
  - Option 2: Rename Thunderlink social grouping to `Guild` (if you want Discord semantics)
- Add relationship from Message to VaultUser (sender_user) for easier preload.

### Phase B: Core Messaging Pipeline
- Implement `create_channel_message/2` to call `Message.create/1`
- Ensure Channel.send_message increments metrics through actual persisted counts
- Add instrumentation (Telemetry) for `:message_published`, `:reaction_updated`

### Phase C: LiveView Chat UI
- New LiveView: `ChatLive` directory: lists channels + current channel messages
- Use LiveView streams for message list
- Subscribe to `"thunderlink:channels:#{id}:messages"`
- Hook presence (see dixord `_process_presence` pattern)
- Provide form for message send; broadcast reply updates

### Phase D: Presence Layer
- Create `ThunderlineWeb.Presence`
- Track typing events (push ephemeral presence meta)
- Display active user list & typing indicator

### Phase E: CLI Interface (Baseline)
- LiveView â€œTerminalâ€:
  - Input command â†’ spawn `Task.async_stream` or `Port.open` (safe sandbox)
  - Stream stdout lines via `send_update`
  - Commands allowed whitelist (e.g., `uptime`, `observer_cli` summary, domain counts)

### Phase F: Attachments (MVP Lite)
- Introduce Attachment resource (table: `attachments`) with metadata only
- Add simple local filesystem storage under `priv/uploads/` (defer S3)
- Validate size & mime
- Link Message.attachments to stored files

### Phase G: Hardening / Policies
- Re-enable Ash policies:
  - Read: public channels open, private require membership (membership concept placeholder)
  - Create message: authenticated or ephemeral guest (generate user on first visit)
  - Edit/delete only owner (except moderators)

## ğŸ” Notable Risks & Debt

| Area | Risk | Mitigation |
|------|------|------------|
| Over-modeled Message schema | Complexity before behavior | Implement critical subset; hide unused fields in API |
| Dual â€œCommunityâ€ concept | Architectural confusion | Rename one early before UI & docs solidify |
| Stubs + commented expressions | Silent failures in metrics/moderation | Add TODO telemetry warnings (Logger.warn once) |
| Search planned but not implemented | Index mismatch in migrations | Push search to post-MVP; remove GIN index until vector implemented to avoid confusion |
| Broadcast prefix mismatch | Developer confusion/client mismatch | Fix before clients consume topics |
| No migration audit for all new resources | Runtime break risk | Run `mix ash.codegen --dry-run` & capture diff before changes |
| Reaction scalability (map of emoji => list of user ids) | Large memory row growth | MVP ok; plan pivot to join table if high usage |

## â™»ï¸ Reuse & Leverage Points

- CircuitBreaker & Backoff for CLI command resilience (wrap external spawn)
- SystemEvent resource to emit system â†’ channel â€œsystem messagesâ€ (e.g., a deployment notice)
- Existing dashboard LiveView template patterns for layout integration
- Oban (with AshOban) for scheduled ephemeral cleanup & moderation scanning
- VaultUser for identity; add ephemeral guest-provision path using role=:guest

## ğŸ§ª Quick Wins (You Can Get Visible Progress Fast)
1. Add Presence module + single ChatLive that subscribes to one channel hardcoded (demo).
2. Wire Channel.send_message to Message.create + broadcast real persisted record.
3. Show messages updating live in a stream with typing indicator.
4. Provide `/chat` route (separate from metrics dashboard) as the heartbeat page.

## ğŸ“Œ Suggested Initial Task Breakdown (Ready to Assign)

| Task | Type | Est |
|------|------|-----|
| Introduce Presence module & register in supervision tree | Infra | 0.5d |
| Rename PubSub topics + adjust broadcasts | Refactor | 0.25d |
| Implement `create_channel_message/2` & fix pin_message namespace call | Feature | 0.5d |
| Add relationship Message -> VaultUser & preload pipeline | Data | 0.25d |
| Build `ChatLive` (list + messages + form + presence list) | UI/Real-time | 1d |
| Add typing events (phx-change debounce) | Enhancement | 0.25d |
| Basic guest provisioning (fallback anonymous user) | Auth | 0.5d |
| CLI LiveView placeholder (command echo) | Feature | 0.5d |
| Telemetry events for message published/reaction updated | Observability | 0.25d |
| Policy skeleton re-enable (read/create/update own) | Security | 0.5d |

~4.5â€“5 dev days baseline to visible prototype.

## ğŸ› ï¸ Items to Defer (Not Required for First Demo)
- Full-text search (needs tsvector generation & trigger function)
- Federation metadata semantics
- Moderation automation (toxicity scoring)
- AI/PAC command flows
- Voice channel mechanics
- Rate limiting enforcement (can stub telemetry counters first)

## âœ‹ Alignment
Yesâ€”Iâ€™m fully synced (â€œwith youâ€). You already have a feature-rich schema layer; the MVP gap is mostly behavioral wiring + real-time UX and trimming over-designed surface area into a crisp, demoable slice.

## â–¶ï¸ Ready to Execute
If you give the word, Iâ€™ll start Phase A (topic renames + presence scaffolding + message persistence fix) and then move directly into the ChatLive.

Want me to begin implementing Phase A now? Just say â€œgoâ€ (or point me to a different starting slice).
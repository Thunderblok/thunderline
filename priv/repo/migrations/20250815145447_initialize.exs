defmodule Thunderline.Repo.Migrations.Initialize do
  @moduledoc """
  Updates resources based on their most recent snapshots.

  This file was autogenerated with `mix ash_postgres.generate_migrations`
  """

  use Ecto.Migration

  def up do
    # Ensure pgcrypto extension exists for gen_random_uuid()
    execute "CREATE EXTENSION IF NOT EXISTS pgcrypto"
    execute "CREATE EXTENSION IF NOT EXISTS citext"

    create table(:task_orchestrators, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :workflow_name, :text, null: false
      add :workflow_version, :text, default: "1.0.0"
      add :tasks, {:array, :map}, null: false
      add :dependencies, :map, default: %{}
      add :status, :text
      add :execution_strategy, :text
      add :retry_policy, :map
      add :timeout_ms, :bigint, default: 300_000
      add :execution_log, {:array, :map}, default: []
      add :current_step, :bigint, default: 0
      add :total_steps, :bigint
      add :progress_percentage, :decimal, default: "0.0"
      add :assigned_containers, {:array, :text}, default: []
      add :metadata, :map, default: %{}
      add :started_at, :utc_datetime
      add :completed_at, :utc_datetime

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:task_orchestrators, [:workflow_name, :workflow_version],
             name: "task_orchestrators_unique_workflow_index"
           )

    create table(:users, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :email, :citext, null: false
      add :hashed_password, :text, null: false
      add :confirmed_at, :utc_datetime
      add :first_name, :text
      add :last_name, :text
      add :avatar_url, :text
      add :role, :text, null: false, default: "user"
      add :last_login_at, :utc_datetime
      add :login_count, :bigint, null: false, default: 0

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:users, [:email], name: "users_unique_email_index")

    create table(:memories, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :summary, :text, null: false
      add :full_content, :text, null: false
      add :memory_type, :text, null: false
      add :context_data, :map, default: %{}
      add :sensory_data, :map, default: %{}
      add :emotional_data, :map, default: %{}
      add :vividness, :float, default: 1.0
      add :accessibility, :float, default: 1.0
      add :importance, :float, default: 0.5
      add :times_accessed, :bigint, default: 0
      add :last_accessed_at, :utc_datetime
      add :memory_tags, {:array, :text}, default: []

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :agent_id, :uuid, null: false
      add :memory_node_id, :uuid
    end

    create table(:ising_performance_metrics, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :benchmark_name, :text, null: false
      add :system_info, :map, null: false
      add :problem_size, :map, null: false
      add :algorithm_config, :map, null: false
      add :spins_per_second, :float
      add :energy_evaluations_per_second, :float
      add :memory_usage_mb, :float
      add :compilation_time_ms, :bigint
      add :execution_time_ms, :bigint
      add :total_time_ms, :bigint
      add :backend_info, :map, default: %{}
      add :scaling_factor, :float
      add :quality_metrics, :map, default: %{}

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :environment_tags, {:array, :text}, default: []
    end

    create table(:thunderlane_cell_topology, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :name, :text, null: false
      add :description, :text
      add :lane_coordinator_id, :uuid
      add :width, :bigint, null: false
      add :height, :bigint, null: false
      add :depth, :bigint, null: false
      add :total_cells, :bigint
      add :cells_per_partition, :bigint
      add :partition_count, :bigint
      add :topology_type, :text, null: false, default: "rectangular"
      add :boundary_x, :text, null: false, default: "wrap"
      add :boundary_y, :text, null: false, default: "wrap"
      add :boundary_z, :text, null: false, default: "wrap"
      add :neighborhood_type, :text, null: false, default: "moore_3d"
      add :neighborhood_radius, :bigint, null: false, default: 1
      add :partitioning_strategy, :text, null: false, default: "grid_3d"
      add :partitioning_config, :map, default: %{}
      add :thundercell_nodes, :map, default: %{}
      add :partition_assignments, :map, default: %{}
      add :node_load_balance, :map, default: %{}
      add :average_neighbors_per_cell, :float
      add :max_partition_size, :bigint
      add :min_partition_size, :bigint
      add :load_variance, :float
      add :status, :text, null: false, default: "designed"
      add :distribution_health, :float, default: 1.0
      add :last_rebalance_at, :utc_datetime_usec
      add :locality_score, :float
      add :communication_overhead, :float
      add :memory_efficiency, :float
      add :initial_state_pattern, :text
      add :initial_state_config, :map, default: %{}
      add :initial_state_seed, :bigint
      add :config, :map, default: %{}
      add :metadata, :map, default: %{}

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :coordinator_id, :uuid
    end

    create table(:thunderlane_rulesets, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :version, :bigint, null: false
      add :name, :text, null: false
      add :description, :text
      add :x_lane_rule, :text, null: false
      add :y_lane_rule, :text, null: false
      add :z_lane_rule, :text, null: false
      add :x_lane_params, :map, default: %{}
      add :y_lane_params, :map, default: %{}
      add :z_lane_params, :map, default: %{}
      add :alpha_xy, :float, null: false, default: 0.35
      add :alpha_xz, :float, null: false, default: 0.15
      add :alpha_yx, :float, null: false, default: 0.35
      add :alpha_yz, :float, null: false, default: 0.2
      add :alpha_zx, :float, null: false, default: 0.15
      add :alpha_zy, :float, null: false, default: 0.25
      add :schedule_type, :text, null: false, default: "hybrid_event_wave"
      add :schedule_params, :map, default: %{}
      add :boundaries, :map
      add :parameter_bounds, :map, default: %{}
      add :objective_function, :map
      add :status, :text, null: false, default: "draft"
      add :deployed_at, :utc_datetime_usec
      add :performance_score, :float
      add :signature, :text
      add :signature_algorithm, :text, default: "ed25519"
      add :signed_by, :text
      add :metadata, :map, default: %{}
      add :lane_configuration_id, :uuid

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:embedding_vectors, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :vector, {:array, :float}, null: false
      add :vector_model, :text, null: false
      add :dimension, :bigint, null: false
      add :content_hash, :text, null: false
      add :embedding_type, :text, null: false
      add :metadata, :map, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :memory_record_id,
          references(:memories,
            column: :id,
            name: "embedding_vectors_memory_record_id_fkey",
            type: :uuid,
            prefix: "public"
          )

      add :memory_node_id, :uuid
      add :knowledge_node_id, :uuid
      add :experience_id, :uuid
    end

    create table(:agents, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
    end

    alter table(:memories) do
      modify :agent_id,
             references(:agents,
               column: :id,
               name: "memories_agent_id_fkey",
               type: :uuid,
               prefix: "public"
             )
    end

    alter table(:agents) do
      add :name, :text, null: false
      add :type, :text, null: false
      add :status, :text, null: false, default: "idle"
      add :zone_id, :text
      add :capabilities, {:array, :text}, null: false, default: []
      add :configuration, :map, null: false, default: %{}
      add :state_data, :map, null: false, default: %{}
      add :last_activity_at, :utc_datetime
      add :total_actions, :bigint, null: false, default: 0
      add :success_rate, :decimal, null: false, default: "0.0"
      add :priority, :bigint, null: false, default: 100

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :created_by_user_id,
          references(:users,
            column: :id,
            name: "agents_created_by_user_id_fkey",
            type: :uuid,
            prefix: "public"
          )
    end

    create table(:thunderblock_knowledge_nodes, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :node_type, :text, null: false, default: "concept"
      add :title, :text, null: false
      add :description, :text
      add :aliases, {:array, :text}, null: false, default: []
      add :knowledge_domain, :text, null: false
      add :source_domains, {:array, :text}, null: false, default: []
      add :confidence_level, :decimal, null: false, default: "1.0"
      add :evidence_strength, :decimal, null: false, default: "1.0"
      add :centrality_score, :decimal, null: false, default: "0.5"
      add :memory_record_ids, {:array, :uuid}, null: false, default: []
      add :embedding_vector_ids, {:array, :uuid}, null: false, default: []
      add :relationship_data, :map, null: false
      add :semantic_tags, {:array, :text}, null: false, default: []
      add :temporal_data, :map, null: false
      add :spatial_data, :map, null: false
      add :graph_metrics, :map, null: false
      add :knowledge_quality, :map, null: false
      add :consolidation_data, :map, null: false
      add :discovery_data, :map, null: false
      add :access_patterns, :map, null: false
      add :verification_status, :text, null: false, default: "unverified"
      add :indexing_status, :text, null: false, default: "pending"
      add :taxonomy_path, {:array, :text}, null: false, default: []
      add :metadata, :map, null: false, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create index(:thunderblock_knowledge_nodes, [embedding_vector_ids],
             using: :gin, name: "knowledge_nodes_embeddings_idx"
           )

    create index(:thunderblock_knowledge_nodes, [memory_record_ids],
             name: "knowledge_nodes_memories_idx"
           )

    create index(:thunderblock_knowledge_nodes, [taxonomy_path],
             name: "knowledge_nodes_taxonomy_idx"
           )

    create index(:thunderblock_knowledge_nodes, [relationship_data],
             name: "knowledge_nodes_relationships_idx"
           )

    create index(:thunderblock_knowledge_nodes, [source_domains],
             name: "knowledge_nodes_sources_idx"
           )

    create index(:thunderblock_knowledge_nodes, [semantic_tags],
             name: "knowledge_nodes_tags_idx"
           )

    create index(:thunderblock_knowledge_nodes, [aliases],
             name: "knowledge_nodes_aliases_idx"
           )

    create index(:thunderblock_knowledge_nodes, [:indexing_status],
             name: "knowledge_nodes_indexing_idx"
           )

    create index(:thunderblock_knowledge_nodes, [:confidence_level, :evidence_strength],
             name: "knowledge_nodes_quality_idx"
           )

    create index(:thunderblock_knowledge_nodes, [:verification_status, :centrality_score],
             name: "knowledge_nodes_verification_idx"
           )

    create index(:thunderblock_knowledge_nodes, [:node_type, :knowledge_domain],
             name: "knowledge_nodes_type_domain_idx"
           )

    create unique_index(:thunderblock_knowledge_nodes, [:title, :knowledge_domain],
             name: "thunderblock_knowledge_nodes_unique_title_domain_index"
           )

    create table(:thunderblock_system_events, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :event_type, :text, null: false
      add :source_domain, :text, null: false
      add :target_domain, :text
      add :event_data, :map, default: %{}
      add :status, :text, default: "pending"
      add :priority, :bigint, default: 5
      add :correlation_id, :text
      add :processed_at, :utc_datetime_usec
      add :expires_at, :utc_datetime_usec
      add :target_resource_id, :uuid
      add :target_resource_type, :text

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:thunderblock_system_events, [:correlation_id, :event_type],
             name: "thunderblock_system_events_unique_correlation_event_index",
             where: "(correlation_id IS NOT NULL)"
           )

    create table(:thunderblock_roles, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :role_name, :text, null: false
      add :role_slug, :text, null: false
      add :role_type, :text, null: false, default: "member"
      add :position, :bigint, null: false, default: 0
      add :color, :text
      add :hoist, :boolean, null: false, default: false
      add :mentionable, :boolean, null: false, default: true
      add :permissions, :map, null: false
      add :channel_overrides, :map, null: false, default: %{}
      add :restrictions, :map, null: false
      add :member_count, :bigint, null: false, default: 0
      add :member_ids, {:array, :uuid}, null: false, default: []
      add :auto_assign, :boolean, null: false, default: false
      add :requires_approval, :boolean, null: false, default: false
      add :created_by, :uuid, null: false
      add :moderation_config, :map, null: false
      add :federation_config, :map, null: false
      add :role_flags, {:array, :text}, null: false, default: []
      add :expiry_config, :map, null: false
      add :tags, {:array, :text}, null: false, default: []
      add :metadata, :map, null: false, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :community_id, :uuid
    end

    create index(:thunderblock_roles, [tags], using: :gin, name: "roles_tags_idx")

    create index(:thunderblock_roles, [role_flags], using: :gin, name: "roles_flags_idx")

    create index(:thunderblock_roles, [channel_overrides],
             name: "roles_overrides_idx"
           )

    create index(:thunderblock_roles, [permissions], using: :gin, name: "roles_permissions_idx")

    create index(:thunderblock_roles, [member_ids], using: :gin, name: "roles_members_idx")

    create index(:thunderblock_roles, [:mentionable], name: "roles_mentionable_idx")

    create index(:thunderblock_roles, [:auto_assign, :community_id],
             name: "roles_auto_assign_idx"
           )

    create index(:thunderblock_roles, [:position, :role_type], name: "roles_hierarchy_idx")

    create index(:thunderblock_roles, [:community_id, :role_type],
             name: "roles_community_type_idx"
           )

    create index(:thunderblock_roles, [:community_id, :position],
             name: "roles_community_position_idx"
           )

    create index(:thunderblock_roles, [:role_slug, :community_id],
             name: "roles_slug_community_idx",
             unique: true
           )

    create table(:workflow_trackers, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :workflow_id, :text, null: false
      add :step_name, :text, null: false
      add :target_count, :bigint, null: false
      add :current_count, :bigint, default: 0
      add :status, :text, default: "pending"
      add :domain_context, :text, null: false
      add :next_step_config, :map, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:system_metrics, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :domain, :text, null: false
      add :metric_name, :text, null: false
      add :value, :decimal, null: false
      add :unit, :text
      add :tags, :map, default: %{}
      add :node_name, :text

      add :collected_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:system_metrics, [:domain, :metric_name, :collected_at, :node_name],
             name: "system_metrics_unique_metric_point_index"
           )

    create table(:thunderblock_federation_sockets, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :socket_name, :text, null: false
      add :socket_slug, :text, null: false
      add :socket_type, :text, null: false, default: "bidirectional"
      add :status, :text, null: false, default: "initializing"
      add :target_community_id, :uuid
      add :target_realm_address, :text
      add :federation_protocol, :text, null: false, default: "thundercom_v1"
      add :trust_level, :text, null: false, default: "basic"
      add :connection_config, :map, null: false
      add :message_routing, :map, null: false
      add :sharing_policies, :map, null: false
      add :security_config, :map, null: false
      add :bandwidth_limits, :map, null: false
      add :federation_metrics, :map, null: false
      add :relay_config, :map, null: false
      add :authentication_data, :map, null: false
      add :last_heartbeat, :utc_datetime
      add :last_message_sent, :utc_datetime
      add :last_message_received, :utc_datetime
      add :connection_established_at, :utc_datetime
      add :error_log, {:array, :map}, null: false, default: []
      add :message_queue, {:array, :map}, null: false, default: []
      add :quarantine_queue, {:array, :map}, null: false, default: []
      add :tags, {:array, :text}, null: false, default: []
      add :metadata, :map, null: false, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :community_id, :uuid
    end

    create index(:thunderblock_federation_sockets, [tags],
             name: "federation_sockets_tags_idx"
           )

    create index(:thunderblock_federation_sockets, [error_log],
             name: "federation_sockets_errors_idx"
           )

    create index(:thunderblock_federation_sockets, [federation_metrics],
             name: "federation_sockets_metrics_idx"
           )

    create index(:thunderblock_federation_sockets, [quarantine_queue],
             name: "federation_sockets_quarantine_idx"
           )

    create index(:thunderblock_federation_sockets, [message_queue],
             name: "federation_sockets_queue_idx"
           )

    create index(:thunderblock_federation_sockets, [:target_community_id],
             name: "federation_sockets_target_idx"
           )

    create index(:thunderblock_federation_sockets, [:trust_level, :status],
             name: "federation_sockets_trust_idx"
           )

    create index(:thunderblock_federation_sockets, [:federation_protocol, :status],
             name: "federation_sockets_protocol_idx"
           )

    create index(:thunderblock_federation_sockets, [:status, :last_heartbeat],
             name: "federation_sockets_heartbeat_idx"
           )

    create index(:thunderblock_federation_sockets, [:community_id, :status],
             name: "federation_sockets_community_status_idx"
           )

    create index(:thunderblock_federation_sockets, [:socket_slug, :community_id],
             name: "federation_sockets_slug_community_idx",
             unique: true
           )

    create table(:thundercore_system_policies, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :policy_name, :text, null: false
      add :policy_type, :text, null: false
      add :rule_definition, :map, null: false
      add :enforcement_level, :text, default: "warning"
      add :is_active, :boolean, default: true
      add :violation_count, :bigint, default: 0

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:thundercore_system_policies, [:policy_name],
             name: "thundercore_system_policies_unique_policy_name_index"
           )

    create table(:memory_nodes, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
    end

    alter table(:memories) do
      modify :memory_node_id,
             references(:memory_nodes,
               column: :id,
               name: "memories_memory_node_id_fkey",
               type: :uuid,
               prefix: "public"
             )
    end

    alter table(:embedding_vectors) do
      modify :memory_node_id,
             references(:memory_nodes,
               column: :id,
               name: "embedding_vectors_memory_node_id_fkey",
               type: :uuid,
               prefix: "public"
             )

      modify :knowledge_node_id,
             references(:thunderblock_knowledge_nodes,
               column: :id,
               name: "embedding_vectors_knowledge_node_id_fkey",
               type: :uuid,
               prefix: "public"
             )
    end

    alter table(:memory_nodes) do
      add :title, :text, null: false
      add :content, :text, null: false
      add :content_type, :text, null: false, default: "observation"
      add :importance, :decimal, null: false, default: "0.5"
      add :emotional_valence, :decimal, null: false, default: "0.0"
      add :confidence, :decimal, null: false, default: "0.5"
      add :tags, {:array, :text}, null: false, default: []
      add :context, :map, null: false, default: %{}
      add :access_count, :bigint, null: false, default: 0
      add :last_accessed_at, :utc_datetime
      add :decay_rate, :decimal, null: false, default: "0.01"
      add :is_archived, :boolean, null: false, default: false
      add :content_embedding, {:array, :float}
      add :title_embedding, {:array, :float}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :agent_id,
          references(:agents,
            column: :id,
            name: "memory_nodes_agent_id_fkey",
            type: :uuid,
            prefix: "public"
          ),
          null: false

      add :parent_memory_id,
          references(:memory_nodes,
            column: :id,
            name: "memory_nodes_parent_memory_id_fkey",
            type: :uuid,
            prefix: "public"
          )
    end

    create table(:thunderbit_monitors, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :agent_id, :uuid, null: false
      add :agent_name, :text
      add :status, :text
      add :behavior_type, :text
      add :energy_level, :bigint, default: 100
      add :position_x, :float
      add :position_y, :float
      add :position_z, :float
      add :velocity, :map, default: %{}
      add :last_tick, :utc_datetime
      add :tick_count, :bigint, default: 0
      add :processing_queue_size, :bigint, default: 0
      add :memory_usage_mb, :float
      add :cpu_usage_percent, :float
      add :error_count, :bigint, default: 0
      add :last_error, :text
      add :interactions_count, :bigint, default: 0
      add :performance_score, :float
      add :node_name, :text
      add :metadata, :map, default: %{}

      add :monitored_since, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :last_updated, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:thunderbit_monitors, [:agent_id],
             name: "thunderbit_monitors_unique_agent_monitor_index"
           )

    create table(:thunderlane_lane_metrics, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :metric_type, :text, null: false
      add :source_type, :text, null: false
      add :source_id, :uuid
      add :lane_coordinator_id, :uuid
      add :cross_lane_coupling_id, :uuid
      add :rule_set_id, :uuid
      add :cell_topology_id, :uuid
      add :timestamp, :utc_datetime_usec, null: false
      add :measurement_window_ms, :bigint
      add :sequence_number, :bigint
      add :lane_dimension, :text
      add :updates_per_second, :float
      add :coordination_latency_ms, :float
      add :cells_processed, :bigint
      add :events_processed, :bigint
      add :queue_depth, :bigint
      add :coupling_strength, :float
      add :coupling_latency_ms, :float
      add :mutual_information, :float
      add :phase_coherence, :float
      add :energy_transfer, :float
      add :alpha_effectiveness, :float
      add :throughput, :float
      add :latency_p50_ms, :float
      add :latency_p95_ms, :float
      add :latency_p99_ms, :float
      add :error_rate, :float
      add :success_rate, :float
      add :cpu_usage_percent, :float
      add :memory_usage_mb, :float
      add :memory_usage_percent, :float
      add :network_io_mbps, :float
      add :disk_io_mbps, :float
      add :stability_score, :float, default: 1.0
      add :health_score, :float, default: 1.0
      add :anomaly_score, :float, default: 0.0
      add :optimization_target, :text
      add :optimization_score, :float
      add :improvement_factor, :float
      add :convergence_rate, :float
      add :pathflow_accuracy, :float
      add :pattern_recognition_rate, :float
      add :emergence_detection_count, :bigint
      add :computation_efficiency, :float
      add :raw_metrics, :map, default: %{}
      add :aggregated_metrics, :map, default: %{}
      add :trend_indicators, :map, default: %{}
      add :tags, :map, default: %{}
      add :metadata, :map, default: %{}
      add :measurement_confidence, :float, default: 1.0
      add :data_quality_score, :float, default: 1.0

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :coordinator_id, :uuid
      add :coupling_id, :uuid
      add :topology_id, :uuid
      add :ruleset_id, :uuid
    end

    create table(:thunderblock_messages, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :content, :text, null: false
      add :message_type, :text, null: false, default: "text"
      add :sender_id, :uuid, null: false
      add :sender_type, :text, null: false, default: "user"
      add :status, :text, null: false, default: "active"

      add :reply_to_id,
          references(:thunderblock_messages,
            column: :id,
            name: "thunderblock_messages_reply_to_id_fkey",
            type: :uuid,
            prefix: "public",
            on_delete: :nilify_all,
            on_update: :update_all
          )

      add :thread_root_id,
          references(:thunderblock_messages,
            column: :id,
            name: "thunderblock_messages_thread_root_id_fkey",
            type: :uuid,
            prefix: "public",
            on_delete: :nilify_all,
            on_update: :update_all
          )

      add :attachments, {:array, :map}, null: false, default: []
      add :reactions, :map, null: false, default: %{}
      add :mentions, {:array, :uuid}, null: false, default: []
      add :channel_mentions, {:array, :uuid}, null: false, default: []
      add :role_mentions, {:array, :uuid}, null: false, default: []
      add :message_flags, {:array, :text}, null: false, default: []
      add :edit_history, {:array, :map}, null: false, default: []
      add :ai_metadata, :map, null: false
      add :pac_metadata, :map, null: false
      add :federation_metadata, :map, null: false
      add :search_vector, :text
      add :thread_participant_count, :bigint, null: false, default: 0
      add :thread_message_count, :bigint, null: false, default: 0
      add :last_thread_activity, :utc_datetime
      add :moderation_data, :map, null: false
      add :message_metrics, :map, null: false
      add :ephemeral_until, :utc_datetime
      add :tags, {:array, :text}, null: false, default: []
      add :metadata, :map, null: false, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :channel_id, :uuid
      add :community_id, :uuid
    end

    create index(:thunderblock_messages, [reactions],
             name: "messages_reactions_idx"
           )

    create index(:thunderblock_messages, [tags], using: :gin, name: "messages_tags_idx")

    create index(:thunderblock_messages, [message_flags],
             name: "messages_flags_idx"
           )

    create index(:thunderblock_messages, [mentions], using: :gin, name: "messages_mentions_idx")

    create index(:thunderblock_messages, [search_vector],
             name: "messages_search_idx"
           )

    create index(:thunderblock_messages, [:ephemeral_until], name: "messages_ephemeral_idx")

    create index(:thunderblock_messages, [:message_type, :sender_type], name: "messages_type_idx")

    create index(:thunderblock_messages, [:status, :inserted_at],
             name: "messages_status_time_idx"
           )

    create index(:thunderblock_messages, [:reply_to_id], name: "messages_reply_idx")

    create index(:thunderblock_messages, [:thread_root_id, :inserted_at],
             name: "messages_thread_idx"
           )

    create index(:thunderblock_messages, [:sender_id, :inserted_at],
             name: "messages_sender_time_idx"
           )

    create index(:thunderblock_messages, [:channel_id, :inserted_at],
             name: "messages_channel_time_idx"
           )

    create table(:thundercore_task_nodes, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :node_name, :text, null: false
      add :task_type, :text, null: false
      add :task_config, :map, default: %{}
      add :status, :text, default: "pending"
      add :dependencies, {:array, :text}, default: []
      add :position_x, :bigint, default: 0
      add :position_y, :bigint, default: 0
      add :started_at, :utc_datetime_usec
      add :completed_at, :utc_datetime_usec

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :workflow_dag_id, :uuid
    end

    create table(:thunderblock_distributed_state, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :state_key, :text, null: false
      add :state_scope, :text, default: "global"
      add :state_value, :map, null: false
      add :version, :bigint, default: 1
      add :last_updated_by, :text
      add :ttl_expires_at, :utc_datetime_usec

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:thunderblock_distributed_state, [:state_key, :state_scope],
             name: "thunderblock_distributed_state_unique_state_key_scope_index"
           )

    create table(:ising_optimization_runs, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :problem_id, :uuid, null: false
      add :name, :text
      add :algorithm, :text, null: false
      add :parameters, :map, null: false
      add :status, :text, default: "queued"
      add :result, :map
      add :energy_history, {:array, :float}, default: []
      add :magnetization_history, {:array, :float}, default: []
      add :final_energy, :float
      add :final_magnetization, :float
      add :steps_completed, :bigint, default: 0
      add :runtime_ms, :bigint
      add :converged, :boolean, default: false
      add :error_message, :text
      add :metrics, :map, default: %{}

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :started_at, :utc_datetime
      add :completed_at, :utc_datetime
    end

    create table(:lane_configurations, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :name, :text, null: false
      add :lane_type, :text, null: false, default: "ca"
      add :lane_family, :text, null: false
      add :rule_parameters, :map, default: %{}
      add :performance_target, :decimal, default: "0.85"
      add :max_concurrent_tasks, :bigint, default: 10
      add :priority_weight, :decimal, default: "1.0"
      add :adaptive_bounds, :map
      add :metadata, :map, default: %{}
      add :rule_oracle_id, :uuid

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :state, :text, null: false, default: "initializing"
    end

    create table(:thundermag_task_executions, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :execution_id, :uuid, null: false
      add :macro_command_id, :uuid, null: false
      add :status, :text, null: false, default: "pending"
      add :total_tasks, :bigint, null: false, default: 0
      add :completed_tasks, :bigint, default: 0
      add :failed_tasks, :bigint, default: 0
      add :execution_plan, :map, default: %{}
      add :results, {:array, :map}, default: []
      add :errors, {:array, :map}, default: []
      add :started_at, :utc_datetime
      add :completed_at, :utc_datetime
      add :session_id, :uuid
      add :zone_assignments, {:array, :text}, default: []

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:thunderblock_zone_containers, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :zone_name, :text, null: false
      add :zone_type, :text, null: false, default: "general"
      add :status, :text, null: false, default: "initializing"
      add :coordinates, :map, default: %{}
      add :capacity_config, :map, null: false
      add :current_usage, :map, null: false
      add :zone_config, :map, null: false
      add :supervision_strategy, :text, null: false, default: "one_for_one"
      add :max_restarts, :bigint, null: false, default: 5
      add :max_seconds, :bigint, null: false, default: 60
      add :restart_count, :bigint, null: false, default: 0
      add :last_restart, :utc_datetime
      add :health_score, :decimal, null: false, default: "1.0"
      add :last_health_check, :utc_datetime
      add :neighbor_zones, {:array, :uuid}, null: false, default: []
      add :phase_assignment, :bigint
      add :tags, {:array, :text}, null: false, default: []
      add :metadata, :map, null: false, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :cluster_node_id, :uuid
    end

    create index(:thunderblock_zone_containers, [coordinates],
             name: "zone_containers_coords_idx"
           )

    create index(:thunderblock_zone_containers, [tags],
             name: "zone_containers_tags_idx"
           )

    create index(:thunderblock_zone_containers, [neighbor_zones],
             name: "zone_containers_neighbors_idx"
           )

    create index(:thunderblock_zone_containers, [:phase_assignment],
             name: "zone_containers_phase_idx"
           )

    create index(:thunderblock_zone_containers, [:cluster_node_id, :status],
             name: "zone_containers_node_idx"
           )

    create index(:thunderblock_zone_containers, [:zone_type, :status],
             name: "zone_containers_type_idx"
           )

    create index(:thunderblock_zone_containers, [:status, :health_score],
             name: "zone_containers_health_idx"
           )

    create index(:thunderblock_zone_containers, [:zone_name],
             name: "zone_containers_name_idx",
             unique: true
           )

    create table(:actions, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :type, :text, null: false
      add :name, :text, null: false
      add :parameters, :map, null: false, default: %{}
      add :result, :map
      add :status, :text, null: false, default: "pending"
      add :started_at, :utc_datetime
      add :completed_at, :utc_datetime
      add :duration_ms, :bigint
      add :success, :boolean
      add :error_message, :text
      add :confidence_score, :decimal
      add :cost, :decimal, null: false, default: "0.0"
      add :priority, :bigint, null: false, default: 100

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :agent_id,
          references(:agents,
            column: :id,
            name: "actions_agent_id_fkey",
            type: :uuid,
            prefix: "public"
          ),
          null: false

      add :decision_id, :uuid
      add :parent_action_id, :uuid
    end

    create table(:thundercom_federated_realms, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :realm_name, :text, null: false
      add :federation_url, :text, null: false
      add :trust_level, :text, null: false, default: "untrusted"
      add :protocol_versions, {:array, :text}, null: false
      add :connection_status, :text, null: false, default: "disconnected"
      add :metadata, :map, null: false, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create index(:thundercom_federated_realms, [:connection_status])

    create index(:thundercom_federated_realms, [:trust_level])

    create index(:thundercom_federated_realms, [:realm_name], unique: true)

    create table(:thunderflow_event_streams, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :stream_name, :text, null: false
      add :stream_type, :text, null: false
      add :source_domain, :text, null: false
      add :status, :text, null: false, default: "active"
      add :partition_count, :bigint, null: false, default: 1
      add :retention_hours, :bigint, null: false, default: 168
      add :throughput_config, :map, null: false
      add :event_count, :bigint, null: false, default: 0
      add :last_event_at, :utc_datetime
      add :performance_metrics, :map, null: false, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create index(:thunderflow_event_streams, [:last_event_at])

    create index(:thunderflow_event_streams, [:status])

    create index(:thunderflow_event_streams, [:source_domain])

    create index(:thunderflow_event_streams, [:stream_type])

    create index(:thunderflow_event_streams, [:stream_name], unique: true)

    create table(:thunderlane_coordinators, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
    end

    alter table(:thunderlane_cell_topology) do
      modify :coordinator_id,
             references(:thunderlane_coordinators,
               column: :id,
               name: "thunderlane_cell_topology_coordinator_id_fkey",
               type: :uuid,
               prefix: "public"
             )
    end

    alter table(:thunderlane_lane_metrics) do
      modify :coordinator_id,
             references(:thunderlane_coordinators,
               column: :id,
               name: "thunderlane_lane_metrics_coordinator_id_fkey",
               type: :uuid,
               prefix: "public"
             )
    end

    alter table(:thunderlane_coordinators) do
      add :lane_dimension, :text, null: false
      add :name, :text, null: false
      add :description, :text

      add :active_ruleset_id,
          references(:thunderlane_rulesets,
            column: :id,
            name: "thunderlane_coordinators_active_ruleset_id_fkey",
            type: :uuid,
            prefix: "public"
          )

      add :active_ruleset_version, :bigint
      add :status, :text, null: false, default: "initializing"
      add :topology_shape, :map, null: false
      add :cells_managed, :bigint, default: 0
      add :updates_per_second, :float, default: 0.0
      add :last_sync_at, :utc_datetime_usec
      add :coordination_latency_ms, :float
      add :coordinator_pid, :text
      add :coordinator_node, :text
      add :last_heartbeat_at, :utc_datetime_usec
      add :coupling_enabled, :boolean, null: false, default: true
      add :coupling_buffers, :map, default: %{}
      add :coupling_backpressure, :map, default: %{}
      add :event_queue_size, :bigint, default: 0
      add :events_processed, :bigint, default: 0
      add :events_dropped, :bigint, default: 0
      add :target_ups, :float, null: false, default: 1.0e3
      add :max_coordination_latency_ms, :float, null: false, default: 5.0
      add :max_queue_size, :bigint, null: false, default: 10000
      add :error_count, :bigint, default: 0
      add :last_error, :text
      add :last_error_at, :utc_datetime_usec
      add :config, :map, default: %{}
      add :metadata, :map, default: %{}

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:tokens, primary_key: false) do
      add :jti, :text, null: false, primary_key: true
      add :subject, :text, null: false
      add :expires_at, :utc_datetime, null: false
      add :purpose, :text, null: false
      add :extra_data, :map

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:thundereye_system_actions, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :action_name, :text, null: false
      add :domain, :text, null: false
      add :status, :text, null: false, default: "running"
      add :result_data, :map, null: false, default: %{}
      add :error_data, :map
      add :duration_ms, :bigint
      add :metadata, :map, null: false, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create index(:thundereye_system_actions, [:status, :inserted_at],
             name: "system_actions_status_time_idx"
           )

    create index(:thundereye_system_actions, [:action_name, :inserted_at],
             name: "system_actions_name_time_idx"
           )

    create index(:thundereye_system_actions, [:domain, :status],
             name: "system_actions_domain_status_idx"
           )

    create table(:user_tokens, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :token, :binary, null: false
      add :context, :text, null: false
      add :sent_to, :text
      add :expires_at, :utc_datetime, null: false
      add :used_at, :utc_datetime

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :user_id,
          references(:users,
            column: :id,
            name: "user_tokens_user_id_fkey",
            type: :uuid,
            prefix: "public"
          ),
          null: false
    end

    create table(:thunderflow_consciousness_flows, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :agent_id, :uuid, null: false
      add :consciousness_type, :text, null: false
      add :mental_state, :map, null: false, default: %{}
      add :awareness_level, :decimal, null: false, default: "0.5"
      add :cognitive_load, :decimal, null: false, default: "0.0"
      add :active_goals, {:array, :text}, null: false, default: []
      add :memory_anchors, {:array, :uuid}, null: false, default: []
      add :emotional_markers, :map, null: false, default: %{}
      add :flow_metadata, :map, null: false, default: %{}
      add :stream_position, :bigint, null: false, default: 0

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create index(:thunderflow_consciousness_flows, [memory_anchors],
             name: "consciousness_flow_memory_anchors_gin_idx"
           )

    create index(:thunderflow_consciousness_flows, [active_goals],
             name: "consciousness_flow_active_goals_gin_idx"
           )

    create index(:thunderflow_consciousness_flows, [:inserted_at])

    create index(:thunderflow_consciousness_flows, [:stream_position])

    create index(:thunderflow_consciousness_flows, [:awareness_level])

    create index(:thunderflow_consciousness_flows, [:consciousness_type])

    create index(:thunderflow_consciousness_flows, [:agent_id])

    create table(:thunderblock_load_balancing_rules, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :rule_name, :text, null: false
      add :target_service, :text, null: false
      add :algorithm, :text, default: "round_robin"
      add :weights, :map, default: %{}
      add :health_check_path, :text
      add :is_active, :boolean, default: true

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:thunderblock_load_balancing_rules, [:rule_name, :target_service],
             name: "thunderblock_load_balancing_rules_unique_rule_service_index"
           )

    create table(:thundercore_workflow_dags, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
    end

    alter table(:thundercore_task_nodes) do
      modify :workflow_dag_id,
             references(:thundercore_workflow_dags,
               column: :id,
               name: "thundercore_task_nodes_workflow_dag_id_fkey",
               type: :uuid,
               prefix: "public"
             )
    end

    alter table(:thundercore_workflow_dags) do
      add :name, :text, null: false
      add :description, :text
      add :status, :text, default: "pending"
      add :priority, :bigint, default: 5
      add :metadata, :map, default: %{}
      add :started_at, :utc_datetime_usec
      add :completed_at, :utc_datetime_usec

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:thundercore_workflow_dags, [:name],
             name: "thundercore_workflow_dags_unique_workflow_name_index"
           )

    create table(:thundercore_agents, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :agent_name, :text, null: false
      add :agent_type, :text, null: false
      add :status, :text, default: "starting"
      add :capabilities, :map, default: %{}
      add :current_task, :text
      add :last_heartbeat, :utc_datetime_usec, default: fragment("(now() AT TIME ZONE 'utc')")

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:thundercore_agents, [:agent_name],
             name: "thundercore_agents_unique_agent_name_index"
           )

    create table(:thunderlane_consensus_runs, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :region_id, :text
      add :trigger_reason, :text
      add :matrix_size, :bigint, null: false
      add :coupling_strength, :float, default: 1.0
      add :initial_temperature, :float, default: 1.5
      add :final_temperature, :float, default: 0.1
      add :max_steps, :bigint, default: 50
      add :final_energy, :float
      add :convergence_steps, :bigint
      add :success, :boolean, default: false
      add :execution_time_ms, :bigint
      add :spin_configuration, :map, default: %{}

      add :lane_configuration_id,
          references(:lane_configurations,
            column: :id,
            name: "thunderlane_consensus_runs_lane_configuration_id_fkey",
            type: :uuid,
            prefix: "public"
          )

      add :rule_oracle_id, :uuid
      add :metadata, :map, default: %{}

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:thundercore_timing_events, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :event_name, :text, null: false
      add :event_type, :text, null: false
      add :scheduled_at, :utc_datetime_usec, null: false
      add :executed_at, :utc_datetime_usec
      add :status, :text, default: "scheduled"
      add :metadata, :map, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:execution_containers, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :name, :text, null: false
      add :status, :text
      add :container_type, :text
      add :resource_limits, :map
      add :environment, :map, default: %{}
      add :security_policy, :map
      add :execution_metadata, :map, default: %{}
      add :node_assignment, :text
      add :started_at, :utc_datetime
      add :completed_at, :utc_datetime

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:execution_containers, [:name],
             name: "execution_containers_unique_container_name_index"
           )

    create table(:external_services, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :name, :text, null: false
      add :base_url, :text, null: false
      add :protocol_type, :text
      add :auth_config, :map
      add :rate_limits, :map, default: %{}
      add :timeout_ms, :bigint, default: 30000
      add :retry_config, :map
      add :headers, :map, default: %{}
      add :status, :text
      add :health_check_url, :text
      add :last_health_check, :utc_datetime
      add :metadata, :map, default: %{}

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:external_services, [:name],
             name: "external_services_unique_service_name_index"
           )

    create unique_index(:external_services, [:base_url],
             name: "external_services_unique_service_url_index"
           )

    create table(:policy_rules, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :name, :text, null: false
      add :rule_type, :text, null: false
      add :scope, :text, null: false
      add :condition_expression, :text
      add :priority, :bigint, default: 100
      add :active, :boolean, default: true
      add :metadata, :map, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:policy_rules, [:name, :scope],
             name: "policy_rules_unique_name_per_scope_index"
           )

    create table(:thunderline_events, primary_key: false) do
      add :domain, :text, null: false
      add :operation_type, :text
      add :criticality, :text, default: "medium"
      add :replay_required, :boolean, null: false, default: false
      add :correlation_id, :text
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :record_id, :uuid, null: false
      add :version, :bigint, null: false, default: 1
      add :metadata, :map, null: false, default: %{}
      add :data, :map, null: false, default: %{}
      add :occurred_at, :utc_datetime_usec, null: false
      add :resource, :text, null: false
      add :action, :text, null: false
      add :action_type, :text, null: false
      add :user_id, :uuid
      add :agent_id, :uuid
    end

    create unique_index(:thunderline_events, [:correlation_id],
             name: "thunderline_events_correlation_events_index"
           )

    create table(:ising_optimization_problems, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
    end

    alter table(:ising_optimization_runs) do
      modify :problem_id,
             references(:ising_optimization_problems,
               column: :id,
               name: "ising_optimization_runs_problem_id_fkey",
               type: :uuid,
               prefix: "public"
             )
    end

    alter table(:ising_optimization_problems) do
      add :name, :text, null: false
      add :description, :text
      add :topology, :text, null: false
      add :dimensions, :map, null: false
      add :coupling_matrix, :map
      add :field_config, :map
      add :boundary_conditions, :text, default: "periodic"
      add :problem_type, :text, null: false
      add :edge_list, {:array, :map}
      add :metadata, :map, default: %{}
      add :tags, {:array, :text}, default: []

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:thunderlane_telemetry_snapshots, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :coordinator_id, :text, null: false
      add :snapshot_type, :text, null: false
      add :window_start_ms, :bigint
      add :window_end_ms, :bigint
      add :window_duration_ms, :bigint
      add :total_events, :bigint, default: 0
      add :event_rate_per_second, :float
      add :burst_count, :bigint, default: 0
      add :anti_bunching_effectiveness, :float
      add :displacement_mean, :float
      add :displacement_variance, :float
      add :tail_exponent, :float
      add :tail_fit_quality, :float
      add :latency_mean_us, :float
      add :latency_median_us, :float
      add :latency_p90_us, :bigint
      add :latency_p95_us, :bigint
      add :latency_p99_us, :bigint
      add :latency_p999_us, :bigint
      add :latency_max_us, :bigint
      add :queue_depth_mean, :float
      add :queue_depth_max, :bigint
      add :backpressure_events, :bigint, default: 0
      add :dropped_events, :bigint, default: 0
      add :cpu_usage_mean, :float
      add :memory_usage_mean_mb, :bigint
      add :memory_usage_max_mb, :bigint
      add :gc_count, :bigint, default: 0
      add :gc_total_time_ms, :bigint, default: 0
      add :network_bytes_in, :bigint, default: 0
      add :network_bytes_out, :bigint, default: 0
      add :coordination_messages, :bigint, default: 0
      add :coordination_latency_us, :bigint
      add :error_count, :bigint, default: 0
      add :anomaly_score, :float, default: 0.0
      add :anomaly_features, :map, default: %{}

      add :lane_configuration_id,
          references(:lane_configurations,
            column: :id,
            name: "thunderlane_telemetry_snapshots_lane_configuration_id_fkey",
            type: :uuid,
            prefix: "public"
          )

      add :rule_oracle_id, :uuid
      add :metadata, :map, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:thunderblock_channels, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
    end

    alter table(:thunderblock_messages) do
      modify :channel_id,
             references(:thunderblock_channels,
               column: :id,
               name: "thunderblock_messages_channel_id_fkey",
               type: :uuid,
               prefix: "public",
               on_delete: :delete_all,
               on_update: :update_all
             )
    end

    alter table(:thunderblock_channels) do
      add :channel_name, :text, null: false
      add :channel_slug, :text, null: false
      add :channel_type, :text, null: false, default: "text"
      add :channel_category, :text
      add :status, :text, null: false, default: "active"
      add :visibility, :text, null: false, default: "public"
      add :topic, :text
      add :channel_config, :map, null: false
      add :voice_config, :map, null: false
      add :permissions_override, :map, null: false, default: %{}
      add :message_count, :bigint, null: false, default: 0
      add :active_participants, :bigint, null: false, default: 0
      add :last_message_at, :utc_datetime
      add :created_by, :uuid, null: false
      add :pinned_message_ids, {:array, :uuid}, null: false, default: []
      add :channel_integrations, :map, null: false
      add :moderation_config, :map, null: false
      add :channel_metrics, :map, null: false
      add :position, :bigint, null: false, default: 0
      add :tags, {:array, :text}, null: false, default: []
      add :metadata, :map, null: false, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :community_id, :uuid
    end

    create index(:thunderblock_channels, [channel_metrics],
             name: "channels_metrics_idx"
           )

    create index(:thunderblock_channels, [tags], using: :gin, name: "channels_tags_idx")

    create index(:thunderblock_channels, [pinned_message_ids],
             name: "channels_pinned_messages_idx"
           )

    create index(:thunderblock_channels, [:visibility, :status], name: "channels_visibility_idx")

    create index(:thunderblock_channels, [:status, :last_message_at],
             name: "channels_activity_idx"
           )

    create index(:thunderblock_channels, [:channel_type, :status],
             name: "channels_type_status_idx"
           )

    create index(:thunderblock_channels, [:community_id, :position],
             name: "channels_community_position_idx"
           )

    create index(:thunderblock_channels, [:community_id, :channel_type],
             name: "channels_community_type_idx"
           )

    create index(:thunderblock_channels, [:channel_slug, :community_id],
             name: "channels_slug_community_idx",
             unique: true
           )

    create table(:performance_traces, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :trace_id, :text, null: false
      add :span_name, :text, null: false
      add :duration_ms, :bigint, null: false
      add :status, :text
      add :domain, :text
      add :operation, :text
      add :metadata, :map, default: %{}
      add :parent_span_id, :text
      add :node_name, :text

      add :started_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :completed_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:performance_traces, [:trace_id, :span_name],
             name: "performance_traces_unique_span_index"
           )

    create table(:thunderlane_rule_oracles, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
    end

    alter table(:lane_configurations) do
      modify :rule_oracle_id,
             references(:thunderlane_rule_oracles,
               column: :id,
               name: "lane_configurations_rule_oracle_id_fkey",
               type: :uuid,
               prefix: "public"
             )
    end

    alter table(:thunderlane_consensus_runs) do
      modify :rule_oracle_id,
             references(:thunderlane_rule_oracles,
               column: :id,
               name: "thunderlane_consensus_runs_rule_oracle_id_fkey",
               type: :uuid,
               prefix: "public"
             )
    end

    alter table(:thunderlane_telemetry_snapshots) do
      modify :rule_oracle_id,
             references(:thunderlane_rule_oracles,
               column: :id,
               name: "thunderlane_telemetry_snapshots_rule_oracle_id_fkey",
               type: :uuid,
               prefix: "public"
             )
    end

    alter table(:thunderlane_rule_oracles) do
      add :name, :text, null: false
      add :implementation, :text, null: false
      add :description, :text
      add :input_size, :bigint, default: 16
      add :hidden_size, :bigint, default: 32
      add :batch_size, :bigint, default: 32
      add :temperature, :float, default: 1.0
      add :total_inferences, :bigint, default: 0
      add :avg_latency_us, :float
      add :error_rate, :float, default: 0.0
      add :last_inference_at, :utc_datetime
      add :model_version, :text
      add :training_examples, :bigint, default: 0
      add :model_size_bytes, :bigint
      add :rule_parameters, :map, default: %{}
      add :performance_metrics, :map, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :state, :text, null: false, default: "initializing"
    end

    create table(:thunderblock_supervision_trees, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :tree_name, :text, null: false
      add :tree_type, :text, null: false, default: "zone_supervisor"
      add :supervision_strategy, :text, null: false, default: "one_for_one"
      add :max_restarts, :bigint, null: false, default: 5
      add :max_seconds, :bigint, null: false, default: 60
      add :status, :text, null: false, default: "starting"
      add :restart_count, :bigint, null: false, default: 0
      add :last_restart, :utc_datetime
      add :child_specs, {:array, :map}, null: false, default: []
      add :running_children, {:array, :text}, null: false, default: []
      add :failed_children, {:array, :map}, null: false, default: []
      add :escalation_level, :bigint, null: false, default: 0
      add :health_score, :decimal, null: false, default: "1.0"
      add :recovery_strategy, :map, null: false
      add :monitoring_config, :map, null: false

      add :parent_tree_id,
          references(:thunderblock_supervision_trees,
            column: :id,
            name: "thunderblock_supervision_trees_parent_tree_id_fkey",
            type: :uuid,
            prefix: "public",
            on_delete: :nilify_all,
            on_update: :update_all
          )

      add :depth_level, :bigint, null: false, default: 0
      add :process_info, :map, null: false, default: %{}
      add :tags, {:array, :text}, null: false, default: []
      add :metadata, :map, null: false, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :cluster_node_id, :uuid
      add :zone_container_id, :uuid
    end

    create index(:thunderblock_supervision_trees, [tags],
             name: "supervision_trees_tags_idx"
           )

    create index(:thunderblock_supervision_trees, [running_children],
             name: "supervision_trees_children_idx"
           )

    create index(:thunderblock_supervision_trees, [:parent_tree_id, :depth_level],
             name: "supervision_trees_hierarchy_idx"
           )

    create index(:thunderblock_supervision_trees, [:escalation_level, :status],
             name: "supervision_trees_escalation_idx"
           )

    create index(:thunderblock_supervision_trees, [:zone_container_id, :depth_level],
             name: "supervision_trees_zone_depth_idx"
           )

    create index(:thunderblock_supervision_trees, [:tree_type, :status],
             name: "supervision_trees_type_idx"
           )

    create index(:thunderblock_supervision_trees, [:status, :health_score],
             name: "supervision_trees_health_idx"
           )

    create index(:thunderblock_supervision_trees, [:tree_name, :zone_container_id],
             name: "supervision_trees_name_zone_idx",
             unique: true
           )

    create table(:thunderblock_pac_homes, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :home_name, :text, null: false
      add :home_slug, :text, null: false
      add :status, :text, null: false, default: "provisioning"
      add :owner_id, :uuid, null: false
      add :pac_config, :map, null: false
      add :resource_limits, :map, null: false
      add :current_usage, :map, null: false
      add :agent_registry, :map, null: false, default: %{}
      add :networking_config, :map, null: false
      add :storage_config, :map, null: false
      add :community_integration, :map, null: false
      add :agent_permissions, :map, null: false
      add :automation_config, :map, null: false
      add :health_metrics, :map, null: false
      add :last_activity, :utc_datetime
      add :last_health_check, :utc_datetime
      add :provisioned_at, :utc_datetime
      add :suspended_until, :utc_datetime
      add :suspension_reason, :text
      add :backup_schedule, :map, null: false
      add :tags, {:array, :text}, null: false, default: []
      add :metadata, :map, null: false, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :community_id, :uuid
      add :zone_container_id, :uuid
    end

    create index(:thunderblock_pac_homes, [tags], using: :gin, name: "pac_homes_tags_idx")

    create index(:thunderblock_pac_homes, [health_metrics],
             name: "pac_homes_health_metrics_idx"
           )

    create index(:thunderblock_pac_homes, [current_usage],
             name: "pac_homes_usage_idx"
           )

    create index(:thunderblock_pac_homes, [agent_registry],
             name: "pac_homes_agents_idx"
           )

    create index(:thunderblock_pac_homes, [:last_health_check], name: "pac_homes_health_idx")

    create index(:thunderblock_pac_homes, [:suspended_until], name: "pac_homes_suspension_idx")

    create index(:thunderblock_pac_homes, [:status, :last_activity],
             name: "pac_homes_activity_idx"
           )

    create index(:thunderblock_pac_homes, [:community_id, :status],
             name: "pac_homes_community_idx"
           )

    create index(:thunderblock_pac_homes, [:owner_id, :status], name: "pac_homes_owner_idx")

    create index(:thunderblock_pac_homes, [:home_slug, :community_id],
             name: "pac_homes_slug_community_idx",
             unique: true
           )

    create table(:thundergrid_zone_boundaries, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :boundary_name, :text, null: false
      add :boundary_type, :text, null: false, default: "standard"
      add :geometry_type, :text, null: false, default: "line"
      add :boundary_points, {:array, :map}, null: false, default: []
      add :permeability, :decimal, null: false, default: "1.0", precision: 3, scale: 2
      add :crossing_rules, :map, null: false
      add :directional_properties, :map, null: false
      add :security_level, :bigint, null: false, default: 0
      add :monitoring_enabled, :boolean, null: false, default: false
      add :crossing_history, :map, null: false
      add :environmental_effects, :map, null: false
      add :maintenance_status, :text, null: false, default: "stable"
      add :last_maintenance, :utc_datetime
      add :zone_id, :uuid, null: false
      add :adjacent_zone_id, :uuid
      add :metadata, :map, null: false, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create index(:thundergrid_zone_boundaries, [crossing_history],
             name: "zone_boundaries_history_idx"
           )

    create index(:thundergrid_zone_boundaries, [boundary_points],
             name: "zone_boundaries_points_idx"
           )

    create index(:thundergrid_zone_boundaries, [:maintenance_status])

    create index(:thundergrid_zone_boundaries, [:monitoring_enabled])

    create index(:thundergrid_zone_boundaries, [:security_level])

    create index(:thundergrid_zone_boundaries, [:boundary_type])

    create index(:thundergrid_zone_boundaries, [:zone_id, :adjacent_zone_id], unique: true)

    create unique_index(:thundergrid_zone_boundaries, [:zone_id, :adjacent_zone_id],
             name: "thundergrid_zone_boundaries_unique_zone_boundary_index"
           )

    create table(:thunderbolt_monitors, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :service_name, :text, null: false
      add :service_type, :text
      add :status, :text
      add :region, :text
      add :node_name, :text
      add :load_percentage, :float, default: 0.0
      add :active_connections, :bigint, default: 0
      add :pending_tasks, :bigint, default: 0
      add :completed_tasks, :bigint, default: 0
      add :failed_tasks, :bigint, default: 0
      add :average_response_time_ms, :float
      add :throughput_per_minute, :float, default: 0.0
      add :memory_usage_mb, :float
      add :cpu_usage_percent, :float
      add :disk_usage_percent, :float
      add :network_bandwidth_mbps, :float
      add :chunk_count, :bigint, default: 0
      add :chunk_size_mb, :float, default: 0.0
      add :replication_factor, :bigint
      add :health_score, :float, default: 100.0
      add :last_heartbeat, :utc_datetime
      add :error_count, :bigint, default: 0
      add :last_error, :text
      add :configuration, :map, default: %{}
      add :metadata, :map, default: %{}

      add :registered_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :last_updated, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:thunderbolt_monitors, [:service_name, :node_name],
             name: "thunderbolt_monitors_unique_service_index"
           )

    create table(:thunderlane_cross_lane_coupling, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
    end

    alter table(:thunderlane_lane_metrics) do
      modify :coupling_id,
             references(:thunderlane_cross_lane_coupling,
               column: :id,
               name: "thunderlane_lane_metrics_coupling_id_fkey",
               type: :uuid,
               prefix: "public"
             )

      modify :topology_id,
             references(:thunderlane_cell_topology,
               column: :id,
               name: "thunderlane_lane_metrics_topology_id_fkey",
               type: :uuid,
               prefix: "public"
             )

      modify :ruleset_id,
             references(:thunderlane_rulesets,
               column: :id,
               name: "thunderlane_lane_metrics_ruleset_id_fkey",
               type: :uuid,
               prefix: "public"
             )
    end

    alter table(:thunderlane_cross_lane_coupling) do
      add :source_lane, :text, null: false
      add :target_lane, :text, null: false
      add :name, :text
      add :rule_set_id, :uuid
      add :alpha_gain, :float, null: false, default: 0.25
      add :coupling_type, :text, null: false, default: "symmetric"
      add :coupling_function, :text, null: false, default: "linear"
      add :coupling_params, :map, default: %{}
      add :spatial_kernel, :text, null: false, default: "cross_3x3"
      add :kernel_params, :map, default: %{}
      add :temporal_delay, :bigint, null: false, default: 0
      add :temporal_window, :bigint, null: false, default: 1
      add :adaptive_enabled, :boolean, null: false, default: false
      add :adaptation_rate, :float, default: 0.01
      add :adaptation_bounds, :map
      add :coupling_strength, :float
      add :mutual_information, :float
      add :phase_coherence, :float
      add :energy_transfer, :float
      add :stability_measure, :float
      add :status, :text, null: false, default: "inactive"
      add :buffer_size, :bigint, default: 0
      add :events_coupled, :bigint, default: 0
      add :coupling_latency_ms, :float
      add :error_count, :bigint, default: 0
      add :last_error, :text
      add :last_error_at, :utc_datetime_usec
      add :health_score, :float, default: 1.0
      add :tuning_history, :map, default: %{}
      add :performance_trend, :text
      add :config, :map, default: %{}
      add :metadata, :map, default: %{}

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :ruleset_id,
          references(:thunderlane_rulesets,
            column: :id,
            name: "thunderlane_cross_lane_coupling_ruleset_id_fkey",
            type: :uuid,
            prefix: "public"
          )
    end

    create unique_index(
             :thunderlane_cross_lane_coupling,
             [:source_lane, :target_lane, :ruleset_id],
             name: "thunderlane_cross_lane_coupling_unique_lane_coupling_index"
           )

    create table(:decision_frameworks, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :name, :text, null: false
      add :description, :text
      add :framework_type, :text, null: false
      add :configuration, :map, default: %{}
      add :active, :boolean, default: true
      add :version, :text, default: "1.0.0"

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:decision_frameworks, [:name],
             name: "decision_frameworks_unique_name_index"
           )

    create table(:thunderblock_communities, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
    end

    alter table(:thunderblock_roles) do
      modify :community_id,
             references(:thunderblock_communities,
               column: :id,
               name: "thunderblock_roles_community_id_fkey",
               type: :uuid,
               prefix: "public",
               on_delete: :delete_all,
               on_update: :update_all
             )
    end

    create unique_index(:thunderblock_roles, [:role_slug, :community_id],
             name: "thunderblock_roles_unique_role_in_community_index"
           )

    alter table(:thunderblock_federation_sockets) do
      modify :target_community_id,
             references(:thunderblock_communities,
               column: :id,
               name: "thunderblock_federation_sockets_target_community_id_fkey",
               type: :uuid,
               prefix: "public",
               on_delete: :nilify_all,
               on_update: :update_all
             )

      modify :community_id,
             references(:thunderblock_communities,
               column: :id,
               name: "thunderblock_federation_sockets_community_id_fkey",
               type: :uuid,
               prefix: "public",
               on_delete: :delete_all,
               on_update: :update_all
             )
    end

    create unique_index(:thunderblock_federation_sockets, [:socket_slug, :community_id],
             name: "federation_socket_community_idx"
           )

    alter table(:thunderblock_messages) do
      modify :community_id,
             references(:thunderblock_communities,
               column: :id,
               name: "thunderblock_messages_community_id_fkey",
               type: :uuid,
               prefix: "public",
               on_delete: :delete_all,
               on_update: :update_all
             )
    end

    alter table(:thunderblock_channels) do
      modify :community_id,
             references(:thunderblock_communities,
               column: :id,
               name: "thunderblock_channels_community_id_fkey",
               type: :uuid,
               prefix: "public",
               on_delete: :delete_all,
               on_update: :update_all
             )
    end

    create unique_index(:thunderblock_channels, [:channel_slug, :community_id],
             name: "thunderblock_channels_unique_channel_in_community_index"
           )

    alter table(:thunderblock_pac_homes) do
      modify :community_id,
             references(:thunderblock_communities,
               column: :id,
               name: "thunderblock_pac_homes_community_id_fkey",
               type: :uuid,
               prefix: "public",
               on_delete: :delete_all,
               on_update: :update_all
             )

      modify :zone_container_id,
             references(:thunderblock_zone_containers,
               column: :id,
               name: "thunderblock_pac_homes_zone_container_id_fkey",
               type: :uuid,
               prefix: "public",
               on_delete: :delete_all,
               on_update: :update_all
             )
    end

    create unique_index(:thunderblock_pac_homes, [:home_slug, :community_id],
             name: "thunderblock_pac_homes_unique_home_in_community_index"
           )

    create unique_index(:thunderblock_pac_homes, [:owner_id, :home_name],
             name: "thunderblock_pac_homes_unique_owner_home_name_index"
           )

    alter table(:thunderblock_communities) do
      add :community_id, :uuid

      add :execution_zone_id,
          references(:thunderblock_zone_containers,
            column: :id,
            name: "thunderblock_communities_execution_zone_id_fkey",
            type: :uuid,
            prefix: "public",
            on_delete: :nilify_all,
            on_update: :update_all
          )

      add :resource_allocation, :map, default: %{}
      add :performance_metrics, :map, default: %{}
      add :status, :text
      add :created_at, :utc_datetime_usec, default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :community_name, :text
      add :community_slug, :text
      add :community_type, :text, default: "standard"
      add :governance_model, :text, default: "hierarchical"
      add :federation_config, :map
      add :community_config, :map
      add :resource_limits, :map
      add :member_count, :bigint, default: 0
      add :channel_count, :bigint, default: 0
      add :pac_home_count, :bigint, default: 0
      add :owner_id, :uuid
      add :moderator_ids, {:array, :uuid}, default: []
      add :member_ids, {:array, :uuid}, default: []
      add :invitation_config, :map
      add :community_policies, :map
      add :vault_mount_id, :uuid
      add :federation_socket_id, :uuid
      add :community_metrics, :map
      add :tags, {:array, :text}, default: []
      add :metadata, :map, default: %{}
      add :inserted_at, :utc_datetime_usec, default: fragment("(now() AT TIME ZONE 'utc')")
      add :cluster_node_id, :uuid
    end

    create index(:thunderblock_communities, [community_metrics],
             name: "communities_metrics_idx"
           )

    create index(:thunderblock_communities, [federation_config],
             name: "communities_federation_idx"
           )

    create index(:thunderblock_communities, [tags], using: :gin, name: "communities_tags_idx")

    create index(:thunderblock_communities, [moderator_ids],
             name: "communities_moderators_idx"
           )

    create index(:thunderblock_communities, [member_ids],
             name: "communities_members_idx"
           )

    create index(:thunderblock_communities, [:community_type, :governance_model],
             name: "communities_type_idx"
           )

    create index(:thunderblock_communities, [:status, :member_count],
             name: "communities_activity_idx"
           )

    create index(:thunderblock_communities, [:owner_id, :status], name: "communities_owner_idx")

    create index(:thunderblock_communities, [:community_slug],
             name: "communities_slug_idx",
             unique: true
           )

    create table(:thunderblock_query_optimizations, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :query_hash, :text, null: false
      add :query_sql, :text, null: false
      add :execution_time_ms, :decimal, null: false
      add :rows_examined, :bigint
      add :rows_returned, :bigint
      add :index_usage, :map, null: false, default: %{}
      add :execution_plan, :map, null: false, default: %{}
      add :optimization_suggestions, {:array, :text}, null: false, default: []
      add :frequency, :bigint, null: false, default: 1
      add :avg_execution_time, :decimal, null: false

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create index(:thunderblock_query_optimizations, [optimization_suggestions],
             name: "query_optimizations_suggestions_idx"
           )

    create index(:thunderblock_query_optimizations, [:frequency],
             name: "query_optimizations_frequency_idx"
           )

    create index(:thunderblock_query_optimizations, [:avg_execution_time],
             name: "query_optimizations_avg_time_idx"
           )

    create index(:thunderblock_query_optimizations, [:query_hash],
             name: "query_optimizations_hash_idx",
             unique: true
           )

    create unique_index(:thunderblock_query_optimizations, [:query_hash],
             name: "thunderblock_query_optimizations_unique_query_hash_index"
           )

    create table(:error_logs, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :domain, :text, null: false
      add :error_type, :text, null: false
      add :message, :text, null: false
      add :severity, :text
      add :stack_trace, :text
      add :context, :map, default: %{}
      add :node_name, :text
      add :process_id, :text
      add :user_id, :uuid
      add :request_id, :text
      add :metadata, :map, default: %{}
      add :resolved, :boolean, default: false
      add :resolution_notes, :text

      add :occurred_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:error_logs, [:domain, :error_type, :message, :occurred_at],
             name: "error_logs_unique_error_occurrence_index"
           )

    create table(:thunderblock_cluster_nodes, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
    end

    alter table(:thunderblock_zone_containers) do
      modify :cluster_node_id,
             references(:thunderblock_cluster_nodes,
               column: :id,
               name: "thunderblock_zone_containers_cluster_node_id_fkey",
               type: :uuid,
               prefix: "public",
               on_delete: :delete_all,
               on_update: :update_all
             )
    end

    create unique_index(:thunderblock_zone_containers, [:zone_name],
             name: "thunderblock_zone_containers_unique_zone_name_index"
           )

    alter table(:thunderblock_supervision_trees) do
      modify :cluster_node_id,
             references(:thunderblock_cluster_nodes,
               column: :id,
               name: "thunderblock_supervision_trees_cluster_node_id_fkey",
               type: :uuid,
               prefix: "public",
               on_delete: :delete_all,
               on_update: :update_all
             )

      modify :zone_container_id,
             references(:thunderblock_zone_containers,
               column: :id,
               name: "thunderblock_supervision_trees_zone_container_id_fkey",
               type: :uuid,
               prefix: "public",
               on_delete: :delete_all,
               on_update: :update_all
             )
    end

    alter table(:thunderblock_communities) do
      modify :cluster_node_id,
             references(:thunderblock_cluster_nodes,
               column: :id,
               name: "thunderblock_communities_cluster_node_id_fkey",
               type: :uuid,
               prefix: "public",
               on_delete: :delete_all,
               on_update: :update_all
             )
    end

    create unique_index(:thunderblock_communities, [:community_slug],
             name: "thunderblock_communities_unique_community_slug_index"
           )

    alter table(:thunderblock_cluster_nodes) do
      add :node_name, :text, null: false
      add :node_type, :text, default: "worker"
      add :status, :text, default: "offline"
      add :load_score, :decimal, default: "0.0"
      add :capabilities, :map, default: %{}
      add :last_heartbeat, :utc_datetime_usec, default: fragment("(now() AT TIME ZONE 'utc')")
      add :metadata, :map, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:thunderblock_cluster_nodes, [:node_name],
             name: "thunderblock_cluster_nodes_unique_node_name_index"
           )

    create table(:thunderblock_rate_limit_policies, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :policy_name, :text, null: false
      add :target_pattern, :text, null: false
      add :limit_count, :bigint, null: false
      add :limit_window_ms, :bigint, null: false
      add :violation_action, :text, default: "block"
      add :is_active, :boolean, default: true

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:thunderblock_rate_limit_policies, [:policy_name],
             name: "thunderblock_rate_limit_policies_unique_policy_name_index"
           )

    create table(:health_checks, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :component, :text, null: false
      add :domain, :text, null: false
      add :status, :text
      add :response_time_ms, :bigint
      add :message, :text
      add :details, :map, default: %{}
      add :node_name, :text
      add :endpoint_url, :text
      add :check_type, :text
      add :timeout_ms, :bigint, default: 30000
      add :expected_status_code, :bigint
      add :metadata, :map, default: %{}

      add :checked_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:health_checks, [:component, :domain, :checked_at],
             name: "health_checks_unique_check_index"
           )

    create table(:thundercom_federated_messages, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true

      add :source_realm_id,
          references(:thundercom_federated_realms,
            column: :id,
            name: "thundercom_federated_messages_source_realm_id_fkey",
            type: :uuid,
            prefix: "public"
          ),
          null: false

      add :target_realm_id,
          references(:thundercom_federated_realms,
            column: :id,
            name: "thundercom_federated_messages_target_realm_id_fkey",
            type: :uuid,
            prefix: "public"
          )

      add :message_type, :text, null: false
      add :message_content, :map, null: false, default: %{}
      add :signature, :text, null: false
      add :delivery_status, :text, null: false, default: "pending"
      add :delivery_attempts, :bigint, null: false, default: 0
      add :delivered_at, :utc_datetime

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create index(:thundercom_federated_messages, [:inserted_at])

    create index(:thundercom_federated_messages, [:message_type])

    create index(:thundercom_federated_messages, [:delivery_status])

    create index(:thundercom_federated_messages, [:target_realm_id])

    create index(:thundercom_federated_messages, [:source_realm_id])

    create table(:thundereye_audit_logs, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :action_type, :text, null: false
      add :target_resource_type, :text, null: false
      add :target_resource_id, :uuid
      add :actor_id, :uuid
      add :actor_type, :text, null: false, default: "user"
      add :changes, :map, null: false, default: %{}
      add :metadata, :map, null: false, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create index(:thundereye_audit_logs, [:inserted_at], name: "audit_logs_time_idx")

    create index(:thundereye_audit_logs, [:actor_id, :action_type], name: "audit_logs_actor_idx")

    create index(:thundereye_audit_logs, [:target_resource_type, :target_resource_id],
             name: "audit_logs_target_idx"
           )

    create table(:system_actions, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :action_type, :text, null: false
      add :action_name, :text, null: false
      add :parameters, :map, default: %{}
      add :initiated_by, :text, null: false, default: "dashboard"
      add :status, :text, null: false, default: "pending"
      add :result, :map
      add :error_message, :text
      add :execution_time_ms, :bigint

      add :initiated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :completed_at, :utc_datetime_usec

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:system_actions, [:action_type, :initiated_by, :status],
             name: "system_actions_unique_pending_action_index",
             where: "(status = 'pending')"
           )

    create table(:experiences, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
    end

    alter table(:embedding_vectors) do
      modify :experience_id,
             references(:experiences,
               column: :id,
               name: "embedding_vectors_experience_id_fkey",
               type: :uuid,
               prefix: "public"
             )
    end

    create unique_index(:embedding_vectors, [:content_hash, :vector_model],
             name: "embedding_vectors_unique_content_hash_per_model_index"
           )

    alter table(:experiences) do
      add :experience_type, :text, null: false
      add :situation_context, :text, null: false
      add :action_taken, :text, null: false
      add :outcome, :text, null: false
      add :lesson_learned, :text
      add :impact_score, :float, default: 0.5
      add :surprise_factor, :float, default: 0.0
      add :difficulty_level, :bigint, default: 5
      add :times_referenced, :bigint, default: 0
      add :learning_strength, :float, default: 1.0
      add :emotions_felt, {:array, :text}, default: []
      add :skills_used, {:array, :text}, default: []
      add :environmental_factors, :map, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :agent_id,
          references(:agents,
            column: :id,
            name: "experiences_agent_id_fkey",
            type: :uuid,
            prefix: "public"
          ),
          null: false

      add :decision_id, :uuid
      add :action_id, :uuid
    end

    create table(:data_adapters, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :name, :text, null: false
      add :source_format, :text, null: false
      add :target_format, :text, null: false
      add :transformation_rules, :map, null: false
      add :validation_schema, :map
      add :field_mappings, :map, default: %{}
      add :default_values, :map, default: %{}
      add :preprocessing_steps, {:array, :text}, default: []
      add :postprocessing_steps, {:array, :text}, default: []
      add :status, :text
      add :test_input, :map
      add :expected_output, :map
      add :metadata, :map, default: %{}

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:data_adapters, [:name], name: "data_adapters_unique_adapter_name_index")

    create unique_index(:data_adapters, [:source_format, :target_format, :name],
             name: "data_adapters_unique_transformation_path_index"
           )

    create table(:thundercom_realm_identities, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true

      add :realm_id,
          references(:thundercom_federated_realms,
            column: :id,
            name: "thundercom_realm_identities_realm_id_fkey",
            type: :uuid,
            prefix: "public"
          ),
          null: false

      add :public_key, :text, null: false
      add :key_algorithm, :text, null: false, default: "Ed25519"
      add :fingerprint, :text, null: false
      add :verification_status, :text, null: false, default: "unverified"
      add :verified_at, :utc_datetime

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create index(:thundercom_realm_identities, [:verification_status])

    create index(:thundercom_realm_identities, [:fingerprint], unique: true)

    create index(:thundercom_realm_identities, [:realm_id])

    create table(:thundermag_task_assignments, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true

      add :task_execution_id,
          references(:thundermag_task_executions,
            column: :id,
            name: "thundermag_task_assignments_task_execution_id_fkey",
            type: :uuid,
            prefix: "public"
          ),
          null: false

      add :task_id, :uuid, null: false
      add :thunderbit_id, :uuid
      add :zone_id, :text
      add :task_type, :text, null: false
      add :task_value, :text
      add :sequence, :bigint
      add :status, :text, null: false, default: "assigned"
      add :priority, :text, default: "normal"
      add :estimated_execution_time_ms, :bigint
      add :actual_execution_time_ms, :bigint
      add :retry_count, :bigint, default: 0
      add :max_retries, :bigint, default: 3
      add :result, :map
      add :error, :map
      add :assigned_at, :utc_datetime
      add :started_at, :utc_datetime
      add :completed_at, :utc_datetime

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:thundermag_macro_commands, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
    end

    alter table(:thundermag_task_executions) do
      modify :macro_command_id,
             references(:thundermag_macro_commands,
               column: :id,
               name: "thundermag_task_executions_macro_command_id_fkey",
               type: :uuid,
               prefix: "public"
             )
    end

    alter table(:thundermag_macro_commands) do
      add :command_type, :text, null: false
      add :macro_input, :text, null: false
      add :micro_tasks, {:array, :map}, null: false, default: []
      add :status, :text, null: false, default: "pending"
      add :execution_metadata, :map, default: %{}
      add :session_id, :uuid
      add :zone_preferences, {:array, :text}, default: []
      add :priority, :text, default: "normal"
      add :estimated_duration_ms, :bigint
      add :actual_duration_ms, :bigint

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:decisions, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
    end

    alter table(:actions) do
      modify :decision_id,
             references(:decisions,
               column: :id,
               name: "actions_decision_id_fkey",
               type: :uuid,
               prefix: "public"
             )

      modify :parent_action_id,
             references(:actions,
               column: :id,
               name: "actions_parent_action_id_fkey",
               type: :uuid,
               prefix: "public"
             )
    end

    alter table(:experiences) do
      modify :decision_id,
             references(:decisions,
               column: :id,
               name: "experiences_decision_id_fkey",
               type: :uuid,
               prefix: "public"
             )

      modify :action_id,
             references(:actions,
               column: :id,
               name: "experiences_action_id_fkey",
               type: :uuid,
               prefix: "public"
             )
    end

    create unique_index(
             :experiences,
             [:agent_id, :situation_context, :action_taken, :inserted_at],
             name: "experiences_unique_experience_per_context_index"
           )

    alter table(:decisions) do
      add :type, :text, null: false
      add :context, :text, null: false
      add :input_data, :map, null: false, default: %{}
      add :options_considered, {:array, :map}, null: false, default: []
      add :selected_option, :map, null: false
      add :reasoning, :text
      add :confidence_score, :decimal, null: false, default: "0.5"
      add :risk_assessment, :decimal, null: false, default: "0.5"
      add :expected_outcome, :map
      add :actual_outcome, :map
      add :outcome_accuracy, :decimal
      add :decision_time_ms, :bigint, null: false, default: 0
      add :tags, {:array, :text}, null: false, default: []
      add :was_successful, :boolean

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :agent_id,
          references(:agents,
            column: :id,
            name: "decisions_agent_id_fkey",
            type: :uuid,
            prefix: "public"
          ),
          null: false

      add :parent_decision_id,
          references(:decisions,
            column: :id,
            name: "decisions_parent_decision_id_fkey",
            type: :uuid,
            prefix: "public"
          )
    end

    create table(:thundergrid_spatial_coordinates, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :hex_q, :bigint, null: false
      add :hex_r, :bigint, null: false
      add :hex_s, :bigint, null: false
      add :sub_hex_x, :decimal, null: false, default: "0.0", precision: 10, scale: 6
      add :sub_hex_y, :decimal, null: false, default: "0.0", precision: 10, scale: 6
      add :elevation, :decimal, null: false, default: "0.0", precision: 10, scale: 3
      add :coordinate_type, :text, null: false, default: "position"
      add :occupancy_status, :text, null: false, default: "vacant"
      add :occupant_id, :uuid
      add :occupant_type, :text
      add :properties, :map, null: false
      add :navigation_data, :map, null: false
      add :last_accessed, :utc_datetime
      add :zone_id, :uuid
      add :metadata, :map, null: false, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create index(:thundergrid_spatial_coordinates, [properties],
             name: "spatial_coordinates_properties_idx"
           )

    create index(:thundergrid_spatial_coordinates, [:last_accessed])

    create index(:thundergrid_spatial_coordinates, [:coordinate_type])

    create index(:thundergrid_spatial_coordinates, [:occupancy_status])

    create index(:thundergrid_spatial_coordinates, [:occupant_id])

    create index(:thundergrid_spatial_coordinates, [:zone_id])

    create index(:thundergrid_spatial_coordinates, [:hex_q, :hex_r, :hex_s])

    create index(:thundergrid_spatial_coordinates, [:hex_q, :hex_r])

    create unique_index(
             :thundergrid_spatial_coordinates,
             [:hex_q, :hex_r, :sub_hex_x, :sub_hex_y, :elevation],
             name: "thundergrid_spatial_coordinates_unique_hex_position_index"
           )

    create table(:zone_events, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :event_type, :text, null: false
      add :description, :text, null: false
      add :event_data, :map, null: false, default: %{}
      add :severity, :text, null: false, default: "info"
      add :coordinates, :map, null: false
      add :impact_radius, :bigint, null: false, default: 0
      add :duration_ms, :bigint
      add :was_predicted, :boolean, null: false, default: false
      add :prediction_accuracy, :decimal

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :zone_id, :uuid, null: false
      add :agent_id, :uuid
      add :triggered_by_action_id, :uuid
    end

    create table(:thunderblock_cache_entries, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :cache_key, :text, null: false
      add :cache_value, :map, null: false, default: %{}
      add :expires_at, :utc_datetime
      add :hit_count, :bigint, null: false, default: 0
      add :last_hit_at, :utc_datetime
      add :cache_tags, {:array, :text}, null: false, default: []

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create index(:thunderblock_cache_entries, [cache_tags],
             name: "cache_entries_tags_idx"
           )

    create index(:thunderblock_cache_entries, [:expires_at], name: "cache_entries_expires_idx")

    create index(:thunderblock_cache_entries, [:cache_key],
             name: "cache_entries_key_idx",
             unique: true
           )

    create unique_index(:thunderblock_cache_entries, [:cache_key],
             name: "thunderblock_cache_entries_unique_cache_key_index"
           )

    create table(:alert_rules, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :name, :text, null: false
      add :description, :text
      add :domain, :text
      add :component, :text
      add :metric_name, :text
      add :condition, :text
      add :threshold_value, :decimal
      add :threshold_count, :bigint, default: 1
      add :time_window_minutes, :bigint, default: 5
      add :severity, :text
      add :notification_channels, {:array, :text}, default: []
      add :escalation_minutes, :bigint, default: 60
      add :suppression_minutes, :bigint, default: 15
      add :enabled, :boolean, default: true
      add :expression, :text
      add :tags, :map, default: %{}
      add :metadata, :map, default: %{}

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:alert_rules, [:domain, :component, :metric_name, :condition],
             name: "alert_rules_unique_metric_rule_index"
           )

    create unique_index(:alert_rules, [:name], name: "alert_rules_unique_rule_name_index")

    create table(:zones, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
    end

    alter table(:zone_events) do
      modify :zone_id,
             references(:zones,
               column: :id,
               name: "zone_events_zone_id_fkey",
               type: :uuid,
               prefix: "public"
             )

      modify :agent_id,
             references(:thundercore_agents,
               column: :id,
               name: "zone_events_agent_id_fkey",
               type: :uuid,
               prefix: "public"
             )

      modify :triggered_by_action_id,
             references(:actions,
               column: :id,
               name: "zone_events_triggered_by_action_id_fkey",
               type: :uuid,
               prefix: "public"
             )
    end

    alter table(:zones) do
      add :q, :bigint, null: false
      add :r, :bigint, null: false
      add :aspect, :text, null: false, default: "neutral"
      add :entropy, :decimal, null: false, default: "0.0"
      add :energy_level, :decimal, null: false, default: "0.5"
      add :agent_count, :bigint, null: false, default: 0
      add :max_agents, :bigint, null: false, default: 10
      add :properties, :map, null: false, default: %{}
      add :is_active, :boolean, null: false, default: true

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:thunderlane_performance_metrics, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :coordinator_id, :text
      add :metric_type, :text, null: false
      add :step_number, :bigint, null: false
      add :micro_latency_us, :bigint
      add :meso_latency_us, :bigint
      add :macro_latency_us, :bigint
      add :total_latency_us, :bigint
      add :patches_processed, :bigint, default: 0
      add :consensus_bursts, :bigint, default: 0
      add :fusion_operations, :bigint, default: 0
      add :system_energy, :float
      add :energy_drift, :float
      add :stability_score, :float
      add :convergence_rate, :float
      add :lane_x_energy, :float
      add :lane_y_energy, :float
      add :lane_z_energy, :float
      add :alpha_xy, :float
      add :alpha_xz, :float
      add :alpha_yz, :float
      add :oracle_batch_size, :bigint
      add :oracle_success_rate, :float
      add :oracle_latency_us, :bigint
      add :cpu_usage_percent, :float
      add :memory_usage_mb, :bigint
      add :gpu_usage_percent, :float

      add :lane_configuration_id,
          references(:lane_configurations,
            column: :id,
            name: "thunderlane_performance_metrics_lane_configuration_id_fkey",
            type: :uuid,
            prefix: "public"
          )

      add :rule_oracle_id,
          references(:thunderlane_rule_oracles,
            column: :id,
            name: "thunderlane_performance_metrics_rule_oracle_id_fkey",
            type: :uuid,
            prefix: "public"
          )

      add :telemetry_snapshot_id,
          references(:thunderlane_telemetry_snapshots,
            column: :id,
            name: "thunderlane_performance_metrics_telemetry_snapshot_id_fkey",
            type: :uuid,
            prefix: "public"
          )

      add :metadata, :map, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end
  end

  def down do
    drop constraint(
           :thunderlane_performance_metrics,
           "thunderlane_performance_metrics_lane_configuration_id_fkey"
         )

    drop constraint(
           :thunderlane_performance_metrics,
           "thunderlane_performance_metrics_rule_oracle_id_fkey"
         )

    drop constraint(
           :thunderlane_performance_metrics,
           "thunderlane_performance_metrics_telemetry_snapshot_id_fkey"
         )

    drop table(:thunderlane_performance_metrics)

    alter table(:zones) do
      remove :updated_at
      remove :inserted_at
      remove :is_active
      remove :properties
      remove :max_agents
      remove :agent_count
      remove :energy_level
      remove :entropy
      remove :aspect
      remove :r
      remove :q
    end

    drop constraint(:zone_events, "zone_events_zone_id_fkey")

    drop constraint(:zone_events, "zone_events_agent_id_fkey")

    drop constraint(:zone_events, "zone_events_triggered_by_action_id_fkey")

    alter table(:zone_events) do
      modify :triggered_by_action_id, :uuid
      modify :agent_id, :uuid
      modify :zone_id, :uuid
    end

    drop table(:zones)

    drop_if_exists unique_index(:alert_rules, [:name], name: "alert_rules_unique_rule_name_index")

    drop_if_exists unique_index(:alert_rules, [:domain, :component, :metric_name, :condition],
                     name: "alert_rules_unique_metric_rule_index"
                   )

    drop table(:alert_rules)

    drop_if_exists unique_index(:thunderblock_cache_entries, [:cache_key],
                     name: "thunderblock_cache_entries_unique_cache_key_index"
                   )

    drop_if_exists index(:thunderblock_cache_entries, [:cache_key], name: "cache_entries_key_idx")

    drop_if_exists index(:thunderblock_cache_entries, [:expires_at],
                     name: "cache_entries_expires_idx"
                   )

    drop_if_exists index(:thunderblock_cache_entries, [cache_tags],
                     name: "cache_entries_tags_idx"
                   )

    drop table(:thunderblock_cache_entries)

    drop table(:zone_events)

    drop_if_exists unique_index(
                     :thundergrid_spatial_coordinates,
                     [:hex_q, :hex_r, :sub_hex_x, :sub_hex_y, :elevation],
                     name: "thundergrid_spatial_coordinates_unique_hex_position_index"
                   )

    drop_if_exists index(:thundergrid_spatial_coordinates, [:hex_q, :hex_r])

    drop_if_exists index(:thundergrid_spatial_coordinates, [:hex_q, :hex_r, :hex_s])

    drop_if_exists index(:thundergrid_spatial_coordinates, [:zone_id])

    drop_if_exists index(:thundergrid_spatial_coordinates, [:occupant_id])

    drop_if_exists index(:thundergrid_spatial_coordinates, [:occupancy_status])

    drop_if_exists index(:thundergrid_spatial_coordinates, [:coordinate_type])

    drop_if_exists index(:thundergrid_spatial_coordinates, [:last_accessed])

    drop_if_exists index(:thundergrid_spatial_coordinates, [properties],
                     name: "spatial_coordinates_properties_idx"
                   )

    drop table(:thundergrid_spatial_coordinates)

    drop constraint(:decisions, "decisions_agent_id_fkey")

    drop constraint(:decisions, "decisions_parent_decision_id_fkey")

    alter table(:decisions) do
      remove :parent_decision_id
      remove :agent_id
      remove :updated_at
      remove :inserted_at
      remove :was_successful
      remove :tags
      remove :decision_time_ms
      remove :outcome_accuracy
      remove :actual_outcome
      remove :expected_outcome
      remove :risk_assessment
      remove :confidence_score
      remove :reasoning
      remove :selected_option
      remove :options_considered
      remove :input_data
      remove :context
      remove :type
    end

    drop_if_exists unique_index(
                     :experiences,
                     [:agent_id, :situation_context, :action_taken, :inserted_at],
                     name: "experiences_unique_experience_per_context_index"
                   )

    drop constraint(:experiences, "experiences_decision_id_fkey")

    drop constraint(:experiences, "experiences_action_id_fkey")

    alter table(:experiences) do
      modify :action_id, :uuid
      modify :decision_id, :uuid
    end

    drop constraint(:actions, "actions_decision_id_fkey")

    drop constraint(:actions, "actions_parent_action_id_fkey")

    alter table(:actions) do
      modify :parent_action_id, :uuid
      modify :decision_id, :uuid
    end

    drop table(:decisions)

    alter table(:thundermag_macro_commands) do
      remove :updated_at
      remove :inserted_at
      remove :actual_duration_ms
      remove :estimated_duration_ms
      remove :priority
      remove :zone_preferences
      remove :session_id
      remove :execution_metadata
      remove :status
      remove :micro_tasks
      remove :macro_input
      remove :command_type
    end

    drop constraint(
           :thundermag_task_executions,
           "thundermag_task_executions_macro_command_id_fkey"
         )

    alter table(:thundermag_task_executions) do
      modify :macro_command_id, :uuid
    end

    drop table(:thundermag_macro_commands)

    drop constraint(
           :thundermag_task_assignments,
           "thundermag_task_assignments_task_execution_id_fkey"
         )

    drop table(:thundermag_task_assignments)

    drop constraint(:thundercom_realm_identities, "thundercom_realm_identities_realm_id_fkey")

    drop_if_exists index(:thundercom_realm_identities, [:realm_id])

    drop_if_exists index(:thundercom_realm_identities, [:fingerprint])

    drop_if_exists index(:thundercom_realm_identities, [:verification_status])

    drop table(:thundercom_realm_identities)

    drop_if_exists unique_index(:data_adapters, [:source_format, :target_format, :name],
                     name: "data_adapters_unique_transformation_path_index"
                   )

    drop_if_exists unique_index(:data_adapters, [:name],
                     name: "data_adapters_unique_adapter_name_index"
                   )

    drop table(:data_adapters)

    drop constraint(:experiences, "experiences_agent_id_fkey")

    alter table(:experiences) do
      remove :action_id
      remove :decision_id
      remove :agent_id
      remove :updated_at
      remove :inserted_at
      remove :environmental_factors
      remove :skills_used
      remove :emotions_felt
      remove :learning_strength
      remove :times_referenced
      remove :difficulty_level
      remove :surprise_factor
      remove :impact_score
      remove :lesson_learned
      remove :outcome
      remove :action_taken
      remove :situation_context
      remove :experience_type
    end

    drop_if_exists unique_index(:embedding_vectors, [:content_hash, :vector_model],
                     name: "embedding_vectors_unique_content_hash_per_model_index"
                   )

    drop constraint(:embedding_vectors, "embedding_vectors_experience_id_fkey")

    alter table(:embedding_vectors) do
      modify :experience_id, :uuid
    end

    drop table(:experiences)

    drop_if_exists unique_index(:system_actions, [:action_type, :initiated_by, :status],
                     name: "system_actions_unique_pending_action_index"
                   )

    drop table(:system_actions)

    drop_if_exists index(:thundereye_audit_logs, [:target_resource_type, :target_resource_id],
                     name: "audit_logs_target_idx"
                   )

    drop_if_exists index(:thundereye_audit_logs, [:actor_id, :action_type],
                     name: "audit_logs_actor_idx"
                   )

    drop_if_exists index(:thundereye_audit_logs, [:inserted_at], name: "audit_logs_time_idx")

    drop table(:thundereye_audit_logs)

    drop constraint(
           :thundercom_federated_messages,
           "thundercom_federated_messages_source_realm_id_fkey"
         )

    drop constraint(
           :thundercom_federated_messages,
           "thundercom_federated_messages_target_realm_id_fkey"
         )

    drop_if_exists index(:thundercom_federated_messages, [:source_realm_id])

    drop_if_exists index(:thundercom_federated_messages, [:target_realm_id])

    drop_if_exists index(:thundercom_federated_messages, [:delivery_status])

    drop_if_exists index(:thundercom_federated_messages, [:message_type])

    drop_if_exists index(:thundercom_federated_messages, [:inserted_at])

    drop table(:thundercom_federated_messages)

    drop_if_exists unique_index(:health_checks, [:component, :domain, :checked_at],
                     name: "health_checks_unique_check_index"
                   )

    drop table(:health_checks)

    drop_if_exists unique_index(:thunderblock_rate_limit_policies, [:policy_name],
                     name: "thunderblock_rate_limit_policies_unique_policy_name_index"
                   )

    drop table(:thunderblock_rate_limit_policies)

    drop_if_exists unique_index(:thunderblock_cluster_nodes, [:node_name],
                     name: "thunderblock_cluster_nodes_unique_node_name_index"
                   )

    alter table(:thunderblock_cluster_nodes) do
      remove :updated_at
      remove :inserted_at
      remove :metadata
      remove :last_heartbeat
      remove :capabilities
      remove :load_score
      remove :status
      remove :node_type
      remove :node_name
    end

    drop_if_exists unique_index(:thunderblock_communities, [:community_slug],
                     name: "thunderblock_communities_unique_community_slug_index"
                   )

    drop constraint(:thunderblock_communities, "thunderblock_communities_cluster_node_id_fkey")

    alter table(:thunderblock_communities) do
      modify :cluster_node_id, :uuid
    end

    drop constraint(
           :thunderblock_supervision_trees,
           "thunderblock_supervision_trees_cluster_node_id_fkey"
         )

    drop constraint(
           :thunderblock_supervision_trees,
           "thunderblock_supervision_trees_zone_container_id_fkey"
         )

    alter table(:thunderblock_supervision_trees) do
      modify :zone_container_id, :uuid
      modify :cluster_node_id, :uuid
    end

    drop_if_exists unique_index(:thunderblock_zone_containers, [:zone_name],
                     name: "thunderblock_zone_containers_unique_zone_name_index"
                   )

    drop constraint(
           :thunderblock_zone_containers,
           "thunderblock_zone_containers_cluster_node_id_fkey"
         )

    alter table(:thunderblock_zone_containers) do
      modify :cluster_node_id, :uuid
    end

    drop table(:thunderblock_cluster_nodes)

    drop_if_exists unique_index(:error_logs, [:domain, :error_type, :message, :occurred_at],
                     name: "error_logs_unique_error_occurrence_index"
                   )

    drop table(:error_logs)

    drop_if_exists unique_index(:thunderblock_query_optimizations, [:query_hash],
                     name: "thunderblock_query_optimizations_unique_query_hash_index"
                   )

    drop_if_exists index(:thunderblock_query_optimizations, [:query_hash],
                     name: "query_optimizations_hash_idx"
                   )

    drop_if_exists index(:thunderblock_query_optimizations, [:avg_execution_time],
                     name: "query_optimizations_avg_time_idx"
                   )

    drop_if_exists index(:thunderblock_query_optimizations, [:frequency],
                     name: "query_optimizations_frequency_idx"
                   )

    drop_if_exists index(
                     :thunderblock_query_optimizations,
                     [optimization_suggestions],
                     name: "query_optimizations_suggestions_idx"
                   )

    drop table(:thunderblock_query_optimizations)

    drop constraint(:thunderblock_communities, "thunderblock_communities_execution_zone_id_fkey")

    drop_if_exists index(:thunderblock_communities, [:community_slug],
                     name: "communities_slug_idx"
                   )

    drop_if_exists index(:thunderblock_communities, [:owner_id, :status],
                     name: "communities_owner_idx"
                   )

    drop_if_exists index(:thunderblock_communities, [:status, :member_count],
                     name: "communities_activity_idx"
                   )

    drop_if_exists index(:thunderblock_communities, [:community_type, :governance_model],
                     name: "communities_type_idx"
                   )

    drop_if_exists index(:thunderblock_communities, [member_ids],
                     name: "communities_members_idx"
                   )

    drop_if_exists index(:thunderblock_communities, [moderator_ids],
                     name: "communities_moderators_idx"
                   )

    drop_if_exists index(:thunderblock_communities, [tags],
                     name: "communities_tags_idx"
                   )

    drop_if_exists index(:thunderblock_communities, [federation_config],
                     name: "communities_federation_idx"
                   )

    drop_if_exists index(:thunderblock_communities, [community_metrics],
                     name: "communities_metrics_idx"
                   )

    alter table(:thunderblock_communities) do
      remove :cluster_node_id
      remove :inserted_at
      remove :metadata
      remove :tags
      remove :community_metrics
      remove :federation_socket_id
      remove :vault_mount_id
      remove :community_policies
      remove :invitation_config
      remove :member_ids
      remove :moderator_ids
      remove :owner_id
      remove :pac_home_count
      remove :channel_count
      remove :member_count
      remove :resource_limits
      remove :community_config
      remove :federation_config
      remove :governance_model
      remove :community_type
      remove :community_slug
      remove :community_name
      remove :updated_at
      remove :created_at
      remove :status
      remove :performance_metrics
      remove :resource_allocation
      remove :execution_zone_id
      remove :community_id
    end

    drop_if_exists unique_index(:thunderblock_pac_homes, [:owner_id, :home_name],
                     name: "thunderblock_pac_homes_unique_owner_home_name_index"
                   )

    drop_if_exists unique_index(:thunderblock_pac_homes, [:home_slug, :community_id],
                     name: "thunderblock_pac_homes_unique_home_in_community_index"
                   )

    drop constraint(:thunderblock_pac_homes, "thunderblock_pac_homes_community_id_fkey")

    drop constraint(:thunderblock_pac_homes, "thunderblock_pac_homes_zone_container_id_fkey")

    alter table(:thunderblock_pac_homes) do
      modify :zone_container_id, :uuid
      modify :community_id, :uuid
    end

    drop_if_exists unique_index(:thunderblock_channels, [:channel_slug, :community_id],
                     name: "thunderblock_channels_unique_channel_in_community_index"
                   )

    drop constraint(:thunderblock_channels, "thunderblock_channels_community_id_fkey")

    alter table(:thunderblock_channels) do
      modify :community_id, :uuid
    end

    drop constraint(:thunderblock_messages, "thunderblock_messages_community_id_fkey")

    alter table(:thunderblock_messages) do
      modify :community_id, :uuid
    end

    drop_if_exists unique_index(:thunderblock_federation_sockets, [:socket_slug, :community_id],
                     name: "federation_socket_community_idx"
                   )

    drop constraint(
           :thunderblock_federation_sockets,
           "thunderblock_federation_sockets_target_community_id_fkey"
         )

    drop constraint(
           :thunderblock_federation_sockets,
           "thunderblock_federation_sockets_community_id_fkey"
         )

    alter table(:thunderblock_federation_sockets) do
      modify :community_id, :uuid
      modify :target_community_id, :uuid
    end

    drop_if_exists unique_index(:thunderblock_roles, [:role_slug, :community_id],
                     name: "thunderblock_roles_unique_role_in_community_index"
                   )

    drop constraint(:thunderblock_roles, "thunderblock_roles_community_id_fkey")

    alter table(:thunderblock_roles) do
      modify :community_id, :uuid
    end

    drop table(:thunderblock_communities)

    drop_if_exists unique_index(:decision_frameworks, [:name],
                     name: "decision_frameworks_unique_name_index"
                   )

    drop table(:decision_frameworks)

    drop_if_exists unique_index(
                     :thunderlane_cross_lane_coupling,
                     [:source_lane, :target_lane, :ruleset_id],
                     name: "thunderlane_cross_lane_coupling_unique_lane_coupling_index"
                   )

    drop constraint(
           :thunderlane_cross_lane_coupling,
           "thunderlane_cross_lane_coupling_ruleset_id_fkey"
         )

    alter table(:thunderlane_cross_lane_coupling) do
      remove :ruleset_id
      remove :updated_at
      remove :created_at
      remove :metadata
      remove :config
      remove :performance_trend
      remove :tuning_history
      remove :health_score
      remove :last_error_at
      remove :last_error
      remove :error_count
      remove :coupling_latency_ms
      remove :events_coupled
      remove :buffer_size
      remove :status
      remove :stability_measure
      remove :energy_transfer
      remove :phase_coherence
      remove :mutual_information
      remove :coupling_strength
      remove :adaptation_bounds
      remove :adaptation_rate
      remove :adaptive_enabled
      remove :temporal_window
      remove :temporal_delay
      remove :kernel_params
      remove :spatial_kernel
      remove :coupling_params
      remove :coupling_function
      remove :coupling_type
      remove :alpha_gain
      remove :rule_set_id
      remove :name
      remove :target_lane
      remove :source_lane
    end

    drop constraint(:thunderlane_lane_metrics, "thunderlane_lane_metrics_coupling_id_fkey")

    drop constraint(:thunderlane_lane_metrics, "thunderlane_lane_metrics_topology_id_fkey")

    drop constraint(:thunderlane_lane_metrics, "thunderlane_lane_metrics_ruleset_id_fkey")

    alter table(:thunderlane_lane_metrics) do
      modify :ruleset_id, :uuid
      modify :topology_id, :uuid
      modify :coupling_id, :uuid
    end

    drop table(:thunderlane_cross_lane_coupling)

    drop_if_exists unique_index(:thunderbolt_monitors, [:service_name, :node_name],
                     name: "thunderbolt_monitors_unique_service_index"
                   )

    drop table(:thunderbolt_monitors)

    drop_if_exists unique_index(:thundergrid_zone_boundaries, [:zone_id, :adjacent_zone_id],
                     name: "thundergrid_zone_boundaries_unique_zone_boundary_index"
                   )

    drop_if_exists index(:thundergrid_zone_boundaries, [:zone_id, :adjacent_zone_id])

    drop_if_exists index(:thundergrid_zone_boundaries, [:boundary_type])

    drop_if_exists index(:thundergrid_zone_boundaries, [:security_level])

    drop_if_exists index(:thundergrid_zone_boundaries, [:monitoring_enabled])

    drop_if_exists index(:thundergrid_zone_boundaries, [:maintenance_status])

    drop_if_exists index(:thundergrid_zone_boundaries, [boundary_points],
                     name: "zone_boundaries_points_idx"
                   )

    drop_if_exists index(:thundergrid_zone_boundaries, [crossing_history],
                     name: "zone_boundaries_history_idx"
                   )

    drop table(:thundergrid_zone_boundaries)

    drop_if_exists index(:thunderblock_pac_homes, [:home_slug, :community_id],
                     name: "pac_homes_slug_community_idx"
                   )

    drop_if_exists index(:thunderblock_pac_homes, [:owner_id, :status],
                     name: "pac_homes_owner_idx"
                   )

    drop_if_exists index(:thunderblock_pac_homes, [:community_id, :status],
                     name: "pac_homes_community_idx"
                   )

    drop_if_exists index(:thunderblock_pac_homes, [:status, :last_activity],
                     name: "pac_homes_activity_idx"
                   )

    drop_if_exists index(:thunderblock_pac_homes, [:suspended_until],
                     name: "pac_homes_suspension_idx"
                   )

    drop_if_exists index(:thunderblock_pac_homes, [:last_health_check],
                     name: "pac_homes_health_idx"
                   )

    drop_if_exists index(:thunderblock_pac_homes, [agent_registry],
                     name: "pac_homes_agents_idx"
                   )

    drop_if_exists index(:thunderblock_pac_homes, [current_usage],
                     name: "pac_homes_usage_idx"
                   )

    drop_if_exists index(:thunderblock_pac_homes, [health_metrics],
                     name: "pac_homes_health_metrics_idx"
                   )

    drop_if_exists index(:thunderblock_pac_homes, [tags],
                     name: "pac_homes_tags_idx"
                   )

    drop table(:thunderblock_pac_homes)

    drop constraint(
           :thunderblock_supervision_trees,
           "thunderblock_supervision_trees_parent_tree_id_fkey"
         )

    drop_if_exists index(:thunderblock_supervision_trees, [:tree_name, :zone_container_id],
                     name: "supervision_trees_name_zone_idx"
                   )

    drop_if_exists index(:thunderblock_supervision_trees, [:status, :health_score],
                     name: "supervision_trees_health_idx"
                   )

    drop_if_exists index(:thunderblock_supervision_trees, [:tree_type, :status],
                     name: "supervision_trees_type_idx"
                   )

    drop_if_exists index(:thunderblock_supervision_trees, [:zone_container_id, :depth_level],
                     name: "supervision_trees_zone_depth_idx"
                   )

    drop_if_exists index(:thunderblock_supervision_trees, [:escalation_level, :status],
                     name: "supervision_trees_escalation_idx"
                   )

    drop_if_exists index(:thunderblock_supervision_trees, [:parent_tree_id, :depth_level],
                     name: "supervision_trees_hierarchy_idx"
                   )

    drop_if_exists index(:thunderblock_supervision_trees, [running_children],
                     name: "supervision_trees_children_idx"
                   )

    drop_if_exists index(:thunderblock_supervision_trees, [tags],
                     name: "supervision_trees_tags_idx"
                   )

    drop table(:thunderblock_supervision_trees)

    alter table(:thunderlane_rule_oracles) do
      remove :state
      remove :updated_at
      remove :inserted_at
      remove :performance_metrics
      remove :rule_parameters
      remove :model_size_bytes
      remove :training_examples
      remove :model_version
      remove :last_inference_at
      remove :error_rate
      remove :avg_latency_us
      remove :total_inferences
      remove :temperature
      remove :batch_size
      remove :hidden_size
      remove :input_size
      remove :description
      remove :implementation
      remove :name
    end

    drop constraint(
           :thunderlane_telemetry_snapshots,
           "thunderlane_telemetry_snapshots_rule_oracle_id_fkey"
         )

    alter table(:thunderlane_telemetry_snapshots) do
      modify :rule_oracle_id, :uuid
    end

    drop constraint(:thunderlane_consensus_runs, "thunderlane_consensus_runs_rule_oracle_id_fkey")

    alter table(:thunderlane_consensus_runs) do
      modify :rule_oracle_id, :uuid
    end

    drop constraint(:lane_configurations, "lane_configurations_rule_oracle_id_fkey")

    alter table(:lane_configurations) do
      modify :rule_oracle_id, :uuid
    end

    drop table(:thunderlane_rule_oracles)

    drop_if_exists unique_index(:performance_traces, [:trace_id, :span_name],
                     name: "performance_traces_unique_span_index"
                   )

    drop table(:performance_traces)

    drop_if_exists index(:thunderblock_channels, [:channel_slug, :community_id],
                     name: "channels_slug_community_idx"
                   )

    drop_if_exists index(:thunderblock_channels, [:community_id, :channel_type],
                     name: "channels_community_type_idx"
                   )

    drop_if_exists index(:thunderblock_channels, [:community_id, :position],
                     name: "channels_community_position_idx"
                   )

    drop_if_exists index(:thunderblock_channels, [:channel_type, :status],
                     name: "channels_type_status_idx"
                   )

    drop_if_exists index(:thunderblock_channels, [:status, :last_message_at],
                     name: "channels_activity_idx"
                   )

    drop_if_exists index(:thunderblock_channels, [:visibility, :status],
                     name: "channels_visibility_idx"
                   )

    drop_if_exists index(:thunderblock_channels, [pinned_message_ids],
                     name: "channels_pinned_messages_idx"
                   )

    drop_if_exists index(:thunderblock_channels, [tags], name: "channels_tags_idx")

    drop_if_exists index(:thunderblock_channels, [channel_metrics],
                     name: "channels_metrics_idx"
                   )

    alter table(:thunderblock_channels) do
      remove :community_id
      remove :updated_at
      remove :inserted_at
      remove :metadata
      remove :tags
      remove :position
      remove :channel_metrics
      remove :moderation_config
      remove :channel_integrations
      remove :pinned_message_ids
      remove :created_by
      remove :last_message_at
      remove :active_participants
      remove :message_count
      remove :permissions_override
      remove :voice_config
      remove :channel_config
      remove :topic
      remove :visibility
      remove :status
      remove :channel_category
      remove :channel_type
      remove :channel_slug
      remove :channel_name
    end

    drop constraint(:thunderblock_messages, "thunderblock_messages_channel_id_fkey")

    alter table(:thunderblock_messages) do
      modify :channel_id, :uuid
    end

    drop table(:thunderblock_channels)

    drop constraint(
           :thunderlane_telemetry_snapshots,
           "thunderlane_telemetry_snapshots_lane_configuration_id_fkey"
         )

    drop table(:thunderlane_telemetry_snapshots)

    alter table(:ising_optimization_problems) do
      remove :updated_at
      remove :created_at
      remove :tags
      remove :metadata
      remove :edge_list
      remove :problem_type
      remove :boundary_conditions
      remove :field_config
      remove :coupling_matrix
      remove :dimensions
      remove :topology
      remove :description
      remove :name
    end

    drop constraint(:ising_optimization_runs, "ising_optimization_runs_problem_id_fkey")

    alter table(:ising_optimization_runs) do
      modify :problem_id, :uuid
    end

    drop table(:ising_optimization_problems)

    drop_if_exists unique_index(:thunderline_events, [:correlation_id],
                     name: "thunderline_events_correlation_events_index"
                   )

    drop table(:thunderline_events)

    drop_if_exists unique_index(:policy_rules, [:name, :scope],
                     name: "policy_rules_unique_name_per_scope_index"
                   )

    drop table(:policy_rules)

    drop_if_exists unique_index(:external_services, [:base_url],
                     name: "external_services_unique_service_url_index"
                   )

    drop_if_exists unique_index(:external_services, [:name],
                     name: "external_services_unique_service_name_index"
                   )

    drop table(:external_services)

    drop_if_exists unique_index(:execution_containers, [:name],
                     name: "execution_containers_unique_container_name_index"
                   )

    drop table(:execution_containers)

    drop table(:thundercore_timing_events)

    drop constraint(
           :thunderlane_consensus_runs,
           "thunderlane_consensus_runs_lane_configuration_id_fkey"
         )

    drop table(:thunderlane_consensus_runs)

    drop_if_exists unique_index(:thundercore_agents, [:agent_name],
                     name: "thundercore_agents_unique_agent_name_index"
                   )

    drop table(:thundercore_agents)

    drop_if_exists unique_index(:thundercore_workflow_dags, [:name],
                     name: "thundercore_workflow_dags_unique_workflow_name_index"
                   )

    alter table(:thundercore_workflow_dags) do
      remove :updated_at
      remove :inserted_at
      remove :completed_at
      remove :started_at
      remove :metadata
      remove :priority
      remove :status
      remove :description
      remove :name
    end

    drop constraint(:thundercore_task_nodes, "thundercore_task_nodes_workflow_dag_id_fkey")

    alter table(:thundercore_task_nodes) do
      modify :workflow_dag_id, :uuid
    end

    drop table(:thundercore_workflow_dags)

    drop_if_exists unique_index(:thunderblock_load_balancing_rules, [:rule_name, :target_service],
                     name: "thunderblock_load_balancing_rules_unique_rule_service_index"
                   )

    drop table(:thunderblock_load_balancing_rules)

    drop_if_exists index(:thunderflow_consciousness_flows, [:agent_id])

    drop_if_exists index(:thunderflow_consciousness_flows, [:consciousness_type])

    drop_if_exists index(:thunderflow_consciousness_flows, [:awareness_level])

    drop_if_exists index(:thunderflow_consciousness_flows, [:stream_position])

    drop_if_exists index(:thunderflow_consciousness_flows, [:inserted_at])

    drop_if_exists index(:thunderflow_consciousness_flows, [active_goals],
                     name: "consciousness_flow_active_goals_gin_idx"
                   )

    drop_if_exists index(:thunderflow_consciousness_flows, [memory_anchors],
                     name: "consciousness_flow_memory_anchors_gin_idx"
                   )

    drop table(:thunderflow_consciousness_flows)

    drop constraint(:user_tokens, "user_tokens_user_id_fkey")

    drop table(:user_tokens)

    drop_if_exists index(:thundereye_system_actions, [:domain, :status],
                     name: "system_actions_domain_status_idx"
                   )

    drop_if_exists index(:thundereye_system_actions, [:action_name, :inserted_at],
                     name: "system_actions_name_time_idx"
                   )

    drop_if_exists index(:thundereye_system_actions, [:status, :inserted_at],
                     name: "system_actions_status_time_idx"
                   )

    drop table(:thundereye_system_actions)

    drop table(:tokens)

    drop constraint(:thunderlane_coordinators, "thunderlane_coordinators_active_ruleset_id_fkey")

    alter table(:thunderlane_coordinators) do
      remove :updated_at
      remove :created_at
      remove :metadata
      remove :config
      remove :last_error_at
      remove :last_error
      remove :error_count
      remove :max_queue_size
      remove :max_coordination_latency_ms
      remove :target_ups
      remove :events_dropped
      remove :events_processed
      remove :event_queue_size
      remove :coupling_backpressure
      remove :coupling_buffers
      remove :coupling_enabled
      remove :last_heartbeat_at
      remove :coordinator_node
      remove :coordinator_pid
      remove :coordination_latency_ms
      remove :last_sync_at
      remove :updates_per_second
      remove :cells_managed
      remove :topology_shape
      remove :status
      remove :active_ruleset_version
      remove :active_ruleset_id
      remove :description
      remove :name
      remove :lane_dimension
    end

    drop constraint(:thunderlane_lane_metrics, "thunderlane_lane_metrics_coordinator_id_fkey")

    alter table(:thunderlane_lane_metrics) do
      modify :coordinator_id, :uuid
    end

    drop constraint(:thunderlane_cell_topology, "thunderlane_cell_topology_coordinator_id_fkey")

    alter table(:thunderlane_cell_topology) do
      modify :coordinator_id, :uuid
    end

    drop table(:thunderlane_coordinators)

    drop_if_exists index(:thunderflow_event_streams, [:stream_name])

    drop_if_exists index(:thunderflow_event_streams, [:stream_type])

    drop_if_exists index(:thunderflow_event_streams, [:source_domain])

    drop_if_exists index(:thunderflow_event_streams, [:status])

    drop_if_exists index(:thunderflow_event_streams, [:last_event_at])

    drop table(:thunderflow_event_streams)

    drop_if_exists index(:thundercom_federated_realms, [:realm_name])

    drop_if_exists index(:thundercom_federated_realms, [:trust_level])

    drop_if_exists index(:thundercom_federated_realms, [:connection_status])

    drop table(:thundercom_federated_realms)

    drop constraint(:actions, "actions_agent_id_fkey")

    drop table(:actions)

    drop_if_exists index(:thunderblock_zone_containers, [:zone_name],
                     name: "zone_containers_name_idx"
                   )

    drop_if_exists index(:thunderblock_zone_containers, [:status, :health_score],
                     name: "zone_containers_health_idx"
                   )

    drop_if_exists index(:thunderblock_zone_containers, [:zone_type, :status],
                     name: "zone_containers_type_idx"
                   )

    drop_if_exists index(:thunderblock_zone_containers, [:cluster_node_id, :status],
                     name: "zone_containers_node_idx"
                   )

    drop_if_exists index(:thunderblock_zone_containers, [:phase_assignment],
                     name: "zone_containers_phase_idx"
                   )

    drop_if_exists index(:thunderblock_zone_containers, [neighbor_zones],
                     name: "zone_containers_neighbors_idx"
                   )

    drop_if_exists index(:thunderblock_zone_containers, [tags],
                     name: "zone_containers_tags_idx"
                   )

    drop_if_exists index(:thunderblock_zone_containers, [coordinates],
                     name: "zone_containers_coords_idx"
                   )

    drop table(:thunderblock_zone_containers)

    drop table(:thundermag_task_executions)

    drop table(:lane_configurations)

    drop table(:ising_optimization_runs)

    drop_if_exists unique_index(:thunderblock_distributed_state, [:state_key, :state_scope],
                     name: "thunderblock_distributed_state_unique_state_key_scope_index"
                   )

    drop table(:thunderblock_distributed_state)

    drop table(:thundercore_task_nodes)

    drop constraint(:thunderblock_messages, "thunderblock_messages_reply_to_id_fkey")

    drop constraint(:thunderblock_messages, "thunderblock_messages_thread_root_id_fkey")

    drop_if_exists index(:thunderblock_messages, [:channel_id, :inserted_at],
                     name: "messages_channel_time_idx"
                   )

    drop_if_exists index(:thunderblock_messages, [:sender_id, :inserted_at],
                     name: "messages_sender_time_idx"
                   )

    drop_if_exists index(:thunderblock_messages, [:thread_root_id, :inserted_at],
                     name: "messages_thread_idx"
                   )

    drop_if_exists index(:thunderblock_messages, [:reply_to_id], name: "messages_reply_idx")

    drop_if_exists index(:thunderblock_messages, [:status, :inserted_at],
                     name: "messages_status_time_idx"
                   )

    drop_if_exists index(:thunderblock_messages, [:message_type, :sender_type],
                     name: "messages_type_idx"
                   )

    drop_if_exists index(:thunderblock_messages, [:ephemeral_until],
                     name: "messages_ephemeral_idx"
                   )

    drop_if_exists index(:thunderblock_messages, [search_vector],
                     name: "messages_search_idx"
                   )

    drop_if_exists index(:thunderblock_messages, [mentions],
                     name: "messages_mentions_idx"
                   )

    drop_if_exists index(:thunderblock_messages, [message_flags],
                     name: "messages_flags_idx"
                   )

    drop_if_exists index(:thunderblock_messages, [tags], name: "messages_tags_idx")

    drop_if_exists index(:thunderblock_messages, [reactions],
                     name: "messages_reactions_idx"
                   )

    drop table(:thunderblock_messages)

    drop table(:thunderlane_lane_metrics)

    drop_if_exists unique_index(:thunderbit_monitors, [:agent_id],
                     name: "thunderbit_monitors_unique_agent_monitor_index"
                   )

    drop table(:thunderbit_monitors)

    drop constraint(:memory_nodes, "memory_nodes_agent_id_fkey")

    drop constraint(:memory_nodes, "memory_nodes_parent_memory_id_fkey")

    alter table(:memory_nodes) do
      remove :parent_memory_id
      remove :agent_id
      remove :updated_at
      remove :inserted_at
      remove :title_embedding
      remove :content_embedding
      remove :is_archived
      remove :decay_rate
      remove :last_accessed_at
      remove :access_count
      remove :context
      remove :tags
      remove :confidence
      remove :emotional_valence
      remove :importance
      remove :content_type
      remove :content
      remove :title
    end

    drop constraint(:embedding_vectors, "embedding_vectors_memory_node_id_fkey")

    drop constraint(:embedding_vectors, "embedding_vectors_knowledge_node_id_fkey")

    alter table(:embedding_vectors) do
      modify :knowledge_node_id, :uuid
      modify :memory_node_id, :uuid
    end

    drop constraint(:memories, "memories_memory_node_id_fkey")

    alter table(:memories) do
      modify :memory_node_id, :uuid
    end

    drop table(:memory_nodes)

    drop_if_exists unique_index(:thundercore_system_policies, [:policy_name],
                     name: "thundercore_system_policies_unique_policy_name_index"
                   )

    drop table(:thundercore_system_policies)

    drop_if_exists index(:thunderblock_federation_sockets, [:socket_slug, :community_id],
                     name: "federation_sockets_slug_community_idx"
                   )

    drop_if_exists index(:thunderblock_federation_sockets, [:community_id, :status],
                     name: "federation_sockets_community_status_idx"
                   )

    drop_if_exists index(:thunderblock_federation_sockets, [:status, :last_heartbeat],
                     name: "federation_sockets_heartbeat_idx"
                   )

    drop_if_exists index(:thunderblock_federation_sockets, [:federation_protocol, :status],
                     name: "federation_sockets_protocol_idx"
                   )

    drop_if_exists index(:thunderblock_federation_sockets, [:trust_level, :status],
                     name: "federation_sockets_trust_idx"
                   )

    drop_if_exists index(:thunderblock_federation_sockets, [:target_community_id],
                     name: "federation_sockets_target_idx"
                   )

    drop_if_exists index(:thunderblock_federation_sockets, [message_queue],
                     name: "federation_sockets_queue_idx"
                   )

    drop_if_exists index(:thunderblock_federation_sockets, [quarantine_queue],
                     name: "federation_sockets_quarantine_idx"
                   )

    drop_if_exists index(:thunderblock_federation_sockets, [federation_metrics],
                     name: "federation_sockets_metrics_idx"
                   )

    drop_if_exists index(:thunderblock_federation_sockets, [error_log],
                     name: "federation_sockets_errors_idx"
                   )

    drop_if_exists index(:thunderblock_federation_sockets, [tags],
                     name: "federation_sockets_tags_idx"
                   )

    drop table(:thunderblock_federation_sockets)

    drop_if_exists unique_index(
                     :system_metrics,
                     [:domain, :metric_name, :collected_at, :node_name],
                     name: "system_metrics_unique_metric_point_index"
                   )

    drop table(:system_metrics)

    drop table(:workflow_trackers)

    drop_if_exists index(:thunderblock_roles, [:role_slug, :community_id],
                     name: "roles_slug_community_idx"
                   )

    drop_if_exists index(:thunderblock_roles, [:community_id, :position],
                     name: "roles_community_position_idx"
                   )

    drop_if_exists index(:thunderblock_roles, [:community_id, :role_type],
                     name: "roles_community_type_idx"
                   )

    drop_if_exists index(:thunderblock_roles, [:position, :role_type],
                     name: "roles_hierarchy_idx"
                   )

    drop_if_exists index(:thunderblock_roles, [:auto_assign, :community_id],
                     name: "roles_auto_assign_idx"
                   )

    drop_if_exists index(:thunderblock_roles, [:mentionable], name: "roles_mentionable_idx")

    drop_if_exists index(:thunderblock_roles, [member_ids],
                     name: "roles_members_idx"
                   )

    drop_if_exists index(:thunderblock_roles, [permissions],
                     name: "roles_permissions_idx"
                   )

    drop_if_exists index(:thunderblock_roles, [channel_overrides],
                     name: "roles_overrides_idx"
                   )

    drop_if_exists index(:thunderblock_roles, [role_flags], name: "roles_flags_idx")

    drop_if_exists index(:thunderblock_roles, [tags], name: "roles_tags_idx")

    drop table(:thunderblock_roles)

    drop_if_exists unique_index(:thunderblock_system_events, [:correlation_id, :event_type],
                     name: "thunderblock_system_events_unique_correlation_event_index"
                   )

    drop table(:thunderblock_system_events)

    drop_if_exists unique_index(:thunderblock_knowledge_nodes, [:title, :knowledge_domain],
                     name: "thunderblock_knowledge_nodes_unique_title_domain_index"
                   )

    drop_if_exists index(:thunderblock_knowledge_nodes, [:node_type, :knowledge_domain],
                     name: "knowledge_nodes_type_domain_idx"
                   )

    drop_if_exists index(:thunderblock_knowledge_nodes, [:verification_status, :centrality_score],
                     name: "knowledge_nodes_verification_idx"
                   )

    drop_if_exists index(:thunderblock_knowledge_nodes, [:confidence_level, :evidence_strength],
                     name: "knowledge_nodes_quality_idx"
                   )

    drop_if_exists index(:thunderblock_knowledge_nodes, [:indexing_status],
                     name: "knowledge_nodes_indexing_idx"
                   )

    drop_if_exists index(:thunderblock_knowledge_nodes, [aliases],
                     name: "knowledge_nodes_aliases_idx"
                   )

    drop_if_exists index(:thunderblock_knowledge_nodes, [semantic_tags],
                     name: "knowledge_nodes_tags_idx"
                   )

    drop_if_exists index(:thunderblock_knowledge_nodes, [source_domains],
                     name: "knowledge_nodes_sources_idx"
                   )

    drop_if_exists index(:thunderblock_knowledge_nodes, [relationship_data],
                     name: "knowledge_nodes_relationships_idx"
                   )

    drop_if_exists index(:thunderblock_knowledge_nodes, [taxonomy_path],
                     name: "knowledge_nodes_taxonomy_idx"
                   )

    drop_if_exists index(:thunderblock_knowledge_nodes, [memory_record_ids],
                     name: "knowledge_nodes_memories_idx"
                   )

    drop_if_exists index(:thunderblock_knowledge_nodes, [embedding_vector_ids],
                     name: "knowledge_nodes_embeddings_idx"
                   )

    drop table(:thunderblock_knowledge_nodes)

    drop constraint(:agents, "agents_created_by_user_id_fkey")

    alter table(:agents) do
      remove :created_by_user_id
      remove :updated_at
      remove :inserted_at
      remove :priority
      remove :success_rate
      remove :total_actions
      remove :last_activity_at
      remove :state_data
      remove :configuration
      remove :capabilities
      remove :zone_id
      remove :status
      remove :type
      remove :name
    end

    drop constraint(:memories, "memories_agent_id_fkey")

    alter table(:memories) do
      modify :agent_id, :uuid
    end

    drop table(:agents)

    drop constraint(:embedding_vectors, "embedding_vectors_memory_record_id_fkey")

    drop table(:embedding_vectors)

    drop table(:thunderlane_rulesets)

    drop table(:thunderlane_cell_topology)

    drop table(:ising_performance_metrics)

    drop table(:memories)

    drop_if_exists unique_index(:users, [:email], name: "users_unique_email_index")

    drop table(:users)

    drop_if_exists unique_index(:task_orchestrators, [:workflow_name, :workflow_version],
                     name: "task_orchestrators_unique_workflow_index"
                   )

    drop table(:task_orchestrators)
  end
end
